<html>
<head>
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>SecureRoom Terminal</title>
  <style>
  	* {
   		padding: 0;
  		margin: 0;
	  }
    body {
  		background-color: black;
  		color: #bcefe6;
  		font-family: monospace;
      padding: 10px 0;
      text-shadow: 0 0 3px #bcefe6;
      transition: text-shadow 100ms ease;
  	}
  	ul {
		  width:100%;
		  list-style-type: none;
  	}
    dl {
      float: left;
      white-space: pre;
      margin-left: -3em;
      transition: margin 400ms ease;
    }
    dt {
      float: left;
      clear: left;
    }
    dt:after {
      content: "# ";
    }
    dt>span:after {
      content: " ";
    }
    dd.stdout {
      margin-left: 3.6em;
    }
    span.line {
      display: inline-block;
      width: 3.6em;
      text-align: right;
    }
    span.clock {
      margin-left: 3.6em;
    }
    .highlight {
      background-color: #bcefe6;
      color: black;
      box-shadow: 0 0 3px #bcefe6;
    }
    .nofocus {
      background-color: transparent !important;
      color: #bcefe6 !important;
      box-shadow: 0 0 3px #bcefe6;
    }
  </style>
</head>
<body>
<!--pre>
#####################################################
#     ____                     ___                  #
#    / __/__ ______ _________ / _ \___  ___  __ _   #
#   _\ \/ -_) __/ // / __/ -_) , _/ _ \/ _ \/  ' \  #
#  /___/\__/\__/\_,_/_/  \__/_/|_|\___/\___/_/_/_/  #
#                                                   #
#####################################################
</pre-->
<b></b>
<b></b>
<script>
  //^\?([a-z]+) ?([\S]+)?
  function callback(text) {
    /*if (text.indexOf("!") == 0) text = T.get(text.substring(1));
    T.set("result", eval(text));*/
    console.log(text);
  }

  var T = (function (container, callback) {
    var term = container.appendChild(document.createElement("dl")),
        line = 0,
        pntr = 0,
        input = term.appendChild(document.createElement("dt")),
        field = term.appendChild(document.createElement("dd")),
        caret = field.appendChild(document.createElement("span")),
        clock = input.appendChild(document.createElement('span')),
        named = input.appendChild(document.createElement('span')),
        timer = window.setInterval(toggleCaret, 600);

    clock.date = new Date();
    clock.textContent = clock.date.toString().substring(16,24);
    clock.classList.add("clock");

    window.setInterval(function() { 
      clock.date.setTime(Date.now());
      clock.textContent = clock.date.toString().substring(16, 24); 
    }, 1000);

    caret.textContent = " ";
    named.textContent = "[input]"

    window.addEventListener("keydown", control, true);
    window.addEventListener("keypress", write, true);
    window.addEventListener("focus", function() { caret.classList.remove("nofocus"); }, true);
    window.addEventListener("blur", function() { caret.classList.add("nofocus"); }, true);

    function toggleCaret(highlight) {
      if (highlight || !caret.classList.contains("highlight"))
        caret.classList.add("highlight");
      else
        caret.classList.remove("highlight");

      if (highlight) {
        window.clearInterval(timer);
        timer = window.setInterval(toggleCaret, 600);
      }
    }

    function toggleLineNumbers() {
      term.style.marginLeft = (term.style.marginLeft == "0px") ? "-3em" : "0px";
    }

    function control(event) {
      toggleCaret(true);

      switch (event.which) {
        case 13:
          execute();
          event.preventDefault();
          break;
        case 8:
          moveLeft(true);
          break;
        case 46:
          moveRight(true);
          break;
        case 37:
          if (!moveLeft()) toggleLineNumbers();
          break;
        case 39:
          moveRight();
          break;
        case 38:
          if (pntr > 0) { 
            clearLine();
            caret.parentNode.insertBefore(document.createTextNode(term.querySelectorAll("dd.stdin")[--pntr].textContent.trim()), caret);
          }
          event.preventDefault();
          break;
        case 40:
          if (pntr < term.querySelectorAll("dd.stdin").length) {
            clearLine();
            caret.parentNode.insertBefore(document.createTextNode(term.querySelectorAll("dd.stdin")[++pntr].textContent.trim()), caret);
          }
          event.preventDefault();
          break;
        case 35:
          while(moveRight());
          break;
        case 36:
          while(moveLeft());
          break;
        default:
          break;
      }
    }

    function write(event) {
      if (event.which < 32) return;
      if (!caret.previousSibling) caret.parentNode.insertBefore(document.createTextNode(""), caret);
      caret.previousSibling.textContent = caret.previousSibling.textContent + String.fromCharCode(event.which);
    }

    function execute() {
      while(moveRight());
      if (!caret.parentNode || caret.parentNode.textContent == " ") return;

      callback(insertLine(line++, clock.textContent, named.textContent, caret.previousSibling.textContent, "stdin").trim());
      clearLine();
    
      pntr = term.querySelectorAll("dd.stdin").length;
    }

    function insertLine(line, time, name, data, type) {
      var f = term.insertBefore(document.createElement("dt"), input),
          l = f.appendChild(document.createElement("span")),
          t = f.appendChild(document.createElement("span")),
          n = f.appendChild(document.createElement("span"));
      
      l.classList.add("line");
      l.appendChild(document.createTextNode(line));
      t.appendChild(document.createTextNode(time));
      n.appendChild(document.createTextNode(name));

      return insertText(data, type, line);
    }

    function insertText(data, type, id) {
      var f = term.insertBefore(document.createElement("dd"), input);
      
      f.setAttribute("id", id);
      f.classList.add(type);
      f.appendChild(document.createTextNode(data));

      return data;
    }

    function clearLine() {
      if (caret.previousSibling) caret.previousSibling.remove();
      if (caret.nextSibling) caret.nextSibling.remove();
      caret.textContent = " ";
    }

    function moveLeft(remove) {
      if (!caret.previousSibling || caret.previousSibling.textContent == "") return false;
      if (!remove) {
        if (!caret.nextSibling) caret.parentNode.appendChild(document.createTextNode(""));
        caret.nextSibling.textContent = caret.textContent + caret.nextSibling.textContent;
        caret.textContent = caret.previousSibling.textContent.substring(caret.previousSibling.textContent.length - 1);
      }
      caret.previousSibling.textContent = caret.previousSibling.textContent.substring(0, caret.previousSibling.textContent.length - 1);

      return true;
    }

    function moveRight(remove) {
      if (!caret.nextSibling || caret.nextSibling.textContent == "") return false;
      if (!remove) {
        if (!caret.previousSibling) caret.parentNode.insertBefore(document.createTextNode(""), caret);
        caret.previousSibling.textContent = caret.previousSibling.textContent + caret.textContent;
      }
      caret.textContent = caret.nextSibling.textContent.substring(0, 1);
      caret.nextSibling.textContent = caret.nextSibling.textContent.substring(1);

      return true;
    }

    return {
      setLine: function(name, data) {
        return insertLine(line++, clock.textContent, name, data, "");
      },
      getLine: function(line) {
        return document.getElementById(line) && document.getElementById(line).textContent.trim();
      },
      readLine: function(request, callback) {
        return;
      },
      println: function(data, name) {
        return (name) ? insertLine(line++, clock.textContent, name, data, "")
                      : insertText(data, "stdout");
      }
    };
  })(document.body, callback);

console.log(T.println("#####################################################"));
console.log(T.println("#                                                   #"));
console.log(T.println("#  Welcome to TerminalJS. This is an introductory   #"));
console.log(T.println("#  text. It has some information to get started     #"));
console.log(T.println("#                                                   #"));
console.log(T.println("#####################################################"));
T.println(" ");
</script>
</body>
</html>