<html>
<head>
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>SecureRoom Terminal</title>
  <style>
    * {
      padding: 0;
      margin: 0;
    }
    body {
      background-color: black;
      color: #bcefe6;
      font-family: monospace;
      padding: 10px 0;
      text-shadow: 0 0 3px #bcefe6;
      transition: text-shadow 100ms ease;
    }
    #term {
      overflow-y: scroll;
      height: 100%;
    }
    dl {
      float: left;
      white-space: pre;
      margin-left: -3em;
      transition: margin 400ms ease;
    }
    dt {
      float: left;
      clear: left;
    }
    dt:after {
      content: "# ";
    }
    dt>span:after {
      content: " ";
    }
    dd.stdout, dd.stderr {
      margin-left: 3.6em;
    }
    span.line {
      display: inline-block;
      width: 3.6em;
      text-align: right;
    }
    span.clock {
      margin-left: 3.6em;
    }
    .highlight {
      background-color: #bcefe6;
      color: black;
      box-shadow: 0 0 3px #bcefe6;
    }
    .nofocus {
      background-color: transparent !important;
      color: #bcefe6 !important;
      box-shadow: 0 0 3px #bcefe6;
    }
  </style>
</head>
<body>
<!--pre>
#####################################################
#     ____                     ___                  #
#    / __/__ ______ _________ / _ \___  ___  __ _   #
#   _\ \/ -_) __/ // / __/ -_) , _/ _ \/ _ \/  ' \  #
#  /___/\__/\__/\_,_/_/  \__/_/|_|\___/\___/_/_/_/  #
#                                                   #
#####################################################
</pre-->
<div id="term"></div>

<script>
  //^\?([a-z]+) ?([\S]+)?
  /*function setName(stdout, stderr) {
    function arrive() {
      stdout("Please enter a name:");
    }

    arrive();

    return function process(stdin) {
      if(stdin.length > 2) {
        stdout("Name set: " + stdin);
        return setStrength(stdout, stderr);
      }
      stderr("Name not long enough, min. length: 3.");
      arrive();

      return process;
    };
  }

  function setStrength(stdout, stderr) {
    function arrive() {
      stdout("Please choose a key size:");
      stdout("1) 1024 bits");
      stdout("2) 1536 bits");
      stdout("3) 2048 bits");  
    }

    arrive();

    return function process(stdin) {
      if (parseInt(stdin) > 0 && parseInt(stdin) < 4) {
        stdout("Thank you, size set: " + stdin);
        return null;
      }
      stderr("Invalid choice. Please try again.");
      arrive();

      return process;
    };
  }*/

  function EchoApp(stdout, stderr, caller) {
    stdout("Welcome to the echo application");

    return function process(stdin) {
      if (stdin == "quit" && caller != null) return caller(stdout, stderr, null);

      stdout(stdin);

      return process;
    }
  }

  function EvalApp(stdout, stderr) {
    stdout("Welcome to the eval application");

    return function process(stdin) {
      stdout(eval(stdin));

      return process;
    }
  }

  var T = (function (container, state) {
    var term = container.appendChild(document.createElement("dl")),
        input = term.appendChild(document.createElement("dt")),
        field = term.appendChild(document.createElement("dd")),
        caret = field.appendChild(document.createElement("span")),
        clock = input.appendChild(document.createElement('span')),
        label = input.appendChild(document.createElement('span'));

    clock.timer = window.setInterval(toggleCaret, 600);
    clock.date = new Date();
    clock.textContent = clock.date.toString().substring(16,24);
    clock.classList.add("clock");

    window.setInterval(function() { 
      clock.date.setTime(Date.now());
      clock.textContent = clock.date.toString().substring(16, 24); 
    }, 1000);

    caret.textContent = " ";
    caret.line = 0;
    caret.pntr = 0;

    label.textContent = "[input]";

    window.addEventListener("keydown", control, true);
    window.addEventListener("keypress", write, true);
    window.addEventListener("focus", function() { caret.classList.remove("nofocus"); }, true);
    window.addEventListener("blur", function() { caret.classList.add("nofocus"); }, true);

    state = state(function(data) { return insertText(data, "stdout"); }, 
                  function(data) { return insertText(data, "stderr"); });

    function toggleCaret(highlight) {
      if (highlight || !caret.classList.contains("highlight"))
        caret.classList.add("highlight");
      else
        caret.classList.remove("highlight");

      if (highlight) {
        window.clearInterval(clock.timer);
        clock.timer = window.setInterval(toggleCaret, 600);
      }
    }

    function toggleLineNumbers() {
      term.style.marginLeft = (term.style.marginLeft == "0px") ? "-3em" : "0px";
    }

    function control(event) {
      toggleCaret(true);

      switch (event.which) {
        case 13:
          event.preventDefault();
          execute();
        break;

        case 8:
          moveLeft(true);
        break;

        case 46:
          moveRight(true);
        break;

        case 37:
          if (!moveLeft()) toggleLineNumbers();
        break;

        case 39:
          moveRight();
        break;

        case 38:
          event.preventDefault();
          if (caret.pntr > 0) { 
            clearLine();
            caret.parentNode.insertBefore(document.createTextNode(term.querySelectorAll("dd.stdin")[--caret.pntr].textContent.trim()), caret);
          }
        break;

        case 40:
          event.preventDefault();
          var lines = term.querySelectorAll("dd.stdin");
          if (caret.pntr < lines.length) {
            clearLine();
            if (++caret.pntr < lines.length)
              caret.parentNode.insertBefore(document.createTextNode(lines[caret.pntr].textContent.trim()), caret);
          }
        break;

        case 35:
          while(moveRight());
        break;

        case 36:
          while(moveLeft());
        break;
      }
    }

    function write(event) {
      if (event.which < 32) return;

      if (!caret.previousSibling) {
        caret.parentNode.insertBefore(document.createTextNode(String.fromCharCode(event.which)), caret);
      } else {
        caret.previousSibling.textContent = caret.previousSibling.textContent + String.fromCharCode(event.which);
      }
    }

    function execute() {
      while(moveRight());
      if (caret.parentNode.textContent == " ") return;

      state(insertLine(caret.line++, clock.textContent, label.textContent, caret.previousSibling.textContent, "stdin").trim());
      clearLine();
      input.scrollIntoView();
    
      caret.pntr = term.querySelectorAll("dd.stdin").length;
    }

    function insertLine(line, time, name, data, type) {
      var f = term.insertBefore(document.createElement("dt"), input),
          l = f.appendChild(document.createElement("span")),
          t = f.appendChild(document.createElement("span")),
          n = f.appendChild(document.createElement("span"));
      
      l.classList.add("line");
      l.appendChild(document.createTextNode(line));
      t.appendChild(document.createTextNode(time));
      n.appendChild(document.createTextNode(name));

      return insertText(data, type, line);
    }

    function insertText(data, type, id) {
      var f = term.insertBefore(document.createElement("dd"), input);
      
      f.setAttribute("id", id);
      f.classList.add(type);
      f.appendChild(document.createTextNode(data));

      return data;
    }

    function clearLine() {
      if (caret.previousSibling) caret.previousSibling.remove();
      if (caret.nextSibling) caret.nextSibling.remove();
      caret.textContent = " ";
    }

    function moveLeft(remove) {
      if (!caret.previousSibling || caret.previousSibling.textContent == "") return false;
      if (!remove) {
        if (!caret.nextSibling) caret.parentNode.appendChild(document.createTextNode(""));
        caret.nextSibling.textContent = caret.textContent + caret.nextSibling.textContent;
        caret.textContent = caret.previousSibling.textContent.substring(caret.previousSibling.textContent.length - 1);
      }
      caret.previousSibling.textContent = caret.previousSibling.textContent.substring(0, caret.previousSibling.textContent.length - 1);

      return true;
    }

    function moveRight(remove) {
      if (!caret.nextSibling || caret.nextSibling.textContent == "") return false;
      if (!remove) {
        if (!caret.previousSibling) caret.parentNode.insertBefore(document.createTextNode(""), caret);
        caret.previousSibling.textContent = caret.previousSibling.textContent + caret.textContent;
      }
      caret.textContent = caret.nextSibling.textContent.substring(0, 1);
      caret.nextSibling.textContent = caret.nextSibling.textContent.substring(1);

      return true;
    }

    return {
      input: function(name) {
        label.removeChild(label.firstChild);
        label.appendChild(document.createTextNode(name));
      },
      read: function(line) {
        return document.getElementById(line) && document.getElementById(line).textContent.trim();
      },
      print: function(data, name) {
        return (name) ? insertLine(caret.line++, clock.textContent, name, data, "")
                      : insertText(data, "stdout");
      }
    };
  })(document.getElementById("term"), EchoApp);
</script>
</body>
</html>