<html>
<head>
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>SecureRoom Terminal</title>
  <style>
  	* {
   		padding: 0;
  		margin: 0;
	  }
    body {
  		background-color: black;
  		color: #17e717;
  		font-family: monospace;
      padding: 10px;
  	}
  	ul {
		  width:100%;
		  list-style-type: none;
  	}
    li {
      white-space: pre;
    }
    #cursor {
      height: 1em;
      width: 1em;
    }
    #cursor.highlight {
      background-color: #17e717;
      color: black;
    }
  </style>
</head>
<body>
<!--pre>
#####################################################
#                                                   #
#  Welcome to TerminalJS. This is an introductory   #
#  text. It has some information to get started     #
#     ____                     ___                  #
#    / __/__ ______ _________ / _ \___  ___  __ _   #
#   _\ \/ -_) __/ // / __/ -_) , _/ _ \/ _ \/  ' \  #
#  /___/\__/\__/\_,_/_/  \__/_/|_|\___/\___/_/_/_/  #
#                                                   #
#####################################################
</pre-->

<ul id="term"><li class="stdin"><span id="cursor"> </span></li></ul>

<script>
  var cursor = document.getElementById('cursor'),
      term   = document.getElementById('term');

  cursor.timer = window.setInterval(toggleCursor, 550);
  cursor.line  = 0;

  window.addEventListener('keydown', control, true);
  window.addEventListener('keypress', write, true);

  function toggleCursor(highlight) {
    if (highlight || !cursor.classList.contains('highlight')) { 
      cursor.classList.add('highlight');
    } else {
      cursor.classList.remove('highlight');
    }

    if (highlight) {
      window.clearInterval(cursor.timer);
      cursor.timer = window.setInterval(toggleCursor, 550);
    }
  }

  function insertLine(data, position) {
    term.lastChild.insertAdjacentHTML(position, "<li class='stdout'>"+data+"</li>");
  }

  function clearLine() {
    var elem = cursor.parentNode;
    
    resetCursor();
    document.body.appendChild(cursor);
    
    elem.textContent = "";
    elem.appendChild(cursor);
  }

  function resetCursor() {
    if (cursor.nextSibling) {
      cursor.insertAdjacentHTML("beforebegin", cursor.textContent);
      cursor.textContent = " ";
    }

    if (cursor.parentNode.lastChild.textContent == " ") cursor.parentNode.removeChild(cursor.parentNode.lastChild);
  }

  function control(event) {
    toggleCursor(true);
    if (event.which > 46) return;

    switch (event.which) {
      case 8:
        moveLeft(true);
        break;
      case 13:
        execute();
        event.preventDefault();
        break;
      case 37:
        moveLeft();
        break;
      case 39:
        moveRight();
        break;
      case 38:
        if (cursor.line) { 
          clearLine();
          cursor.parentNode.insertBefore(document.createTextNode(term.querySelectorAll("li.stdin")[--cursor.line].firstChild.textContent.trim()), cursor);
        };
        break;
      case 40:
        if (cursor.line < term.querySelectorAll("li.stdin").length-1) {
          clearLine();
          cursor.parentNode.insertBefore(document.createTextNode(term.querySelectorAll("li.stdin")[++cursor.line].firstChild.textContent.trim()), cursor);
        }
        break;
      default:
        break;
    }
  }

  function write(event) {
    if (event.which <= 46 && event.which != 32) return;
    if (!cursor.previousSibling) cursor.parentNode.insertBefore(document.createTextNode(""), cursor);
    cursor.previousSibling.textContent = cursor.previousSibling.textContent + String.fromCharCode(event.which);
  }


  function execute() {
    var next = document.createElement("li");

    next.classList.add("stdin");

    //insertLine(eval(cursor.parentNode.textContent), "afterend");

    resetCursor();
    term.appendChild(next);
    next.appendChild(cursor);
    
    cursor.line = term.querySelectorAll("li.stdin").length-1;
  }

  function moveLeft(remove) {
    if (!cursor.previousSibling || cursor.previousSibling.textContent == "") return;
    if (!remove) {
      if (!cursor.nextSibling) cursor.parentNode.appendChild(document.createTextNode(""));
      cursor.nextSibling.textContent = cursor.textContent + cursor.nextSibling.textContent;
      cursor.textContent = cursor.previousSibling.textContent.substring(cursor.previousSibling.textContent.length - 1);
    }
    cursor.previousSibling.textContent = cursor.previousSibling.textContent.substring(0, cursor.previousSibling.textContent.length - 1);
  }

  function moveRight(remove) {
    if (!cursor.nextSibling || cursor.nextSibling.textContent == "") return;
    if (!remove) {
      if (!cursor.previousSibling) cursor.parentNode.insertBefore(document.createTextNode(""), cursor);
      cursor.previousSibling.textContent = cursor.previousSibling.textContent + cursor.textContent;
      cursor.textContent = cursor.nextSibling.textContent.substring(0, 1); 
    }
    cursor.nextSibling.textContent = cursor.nextSibling.textContent.substring(1);
  }
</script>
</body>
</html>