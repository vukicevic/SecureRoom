<html>
<head>
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>SecureRoom - Key Generator</title>
  <style>
    body {
      margin: 0;
      padding: 0 5px;
      background-color: black;
    }
    #term {
      overflow-y: scroll;
      height: 100%;
      background-color: black;
      color: #bcefe6;
      font-family: monospace;
      text-shadow: 0 0 3px #bcefe6;
    }
    dl {
      float: left;
      white-space: pre;
      margin-left: -3em;
      transition: margin 400ms ease;
    }
    dt {
      float: left;
      clear: left;
    }
    dt:after {
      content: "> ";
    }
    dd.stdout, dd.stderr, span.clock {
      margin-left: 3.6em;
    }
    span.line {
      display: inline-block;
      width: 3.6em;
      text-align: right;
    }
    span.clock:after, span.line:after {
      content: " ";
    }
    dd>span {
      box-shadow: 0 0 3px #bcefe6;
    }
    .highlight {
      background-color: #bcefe6;
      color: black;
    }
    .nofocus {
      background-color: transparent !important;
      color: #bcefe6 !important;
    }
  </style>
  <script src="resources/random.default.js"></script>
  <script src="resources/asymmetric.rsa.js"></script>
  <script src="resources/hash.sha1.js"></script>
  <script src="resources/utils.js"></script>
</head>
<body>
  <div id="term"></div>
  <script>
  function RouterApp(stdout, prompt, caller) {
    stdout("Type 'keygen' to generate RSA keys.");
    return function process(stdin) {
      switch (stdin) {
      case "keygen":
        return KeyGenApp.entry(stdout, prompt, process);
      default:
        stdout("Unknown command");
        return process;
      }
    }
  }

  var KeyGenApp = {
    keys: {s: null, e: null},
    name: null,
    size: null,

    exit: function(stdout, prompt, caller) {
      prompt("");
      return caller;
    },

    entry: function(stdout, prompt, caller) {
      stdout(" ", "Welcome to the RSA keygen app");
      prompt("keygen");
      return KeyGenApp.enterType(stdout, prompt, caller);
    },

    enterType: function(stdout, prompt, caller) {
      function print() {
        stdout(" ", "Do you wish to generate and export an OpenPGP style key, or just generate the key?", " ");
        stdout("1) Key Generation");
        stdout("2) Key Generation and OpenPGP Key Export", " ");
      }

      print();

      return function process(stdin) {
        if (stdin == 2)
          return KeyGenApp.enterName(stdout, prompt, caller);
        if (stdin == 1)
          return KeyGenApp.enterSize(stdout, prompt, caller);

        stdout(" ", "Invalid input. Please select one of the presented options", " ");
        print();
        return process;
      }
    },

    enterName: function(stdout, prompt, caller) {
      function print() {
        stdout(" ", "Enter a name. E.g. Bob, Mike, Bob Smith <bob@smith.com>", " ");
      }

      print();

      return function process(stdin) {
        if (stdin.length > 2 && stdin.length < 250) {
          KeyGenApp.name = stdin;
          return KeyGenApp.enterSize(stdout, prompt, caller);
        }

        stdout(" ", "Invalid input. Name must be between 3 and 250 characters long");
        print();
        return process;
      }
    },

    enterSize: function(stdout, prompt, caller) {
      function print() {
        stdout(" ", "Enter a key size in bits, e.g. 1024, 1536, 2048", " ");
      }

      print();

      return function process(stdin) {
        if (stdin > 127 && stdin < 4097) {
          KeyGenApp.size = stdin;
          if (KeyGenApp.name != null) {
            var callback = KeyGenApp.printGpg(stdout, prompt, caller);
            KeyGen(KeyGenApp.size, callback)();
            KeyGen(KeyGenApp.size, callback)();
          } else {
            KeyGen(KeyGenApp.size, KeyGenApp.printRaw(stdout, prompt, caller))();
          }

          return KeyGenApp.exit(stdout, prompt, caller);
        }

        stdout(" ", "Invalid input. Size must be between 128 and 4096 bits long.");
        print();
        return process;
      }
    },

    printGpg: function(stdout, prompt, caller) {
      function print() {
        stdout(" ", "Your keys are being generated...", " ");
      }

      print();

      return function process(stdin) {
        var c = Math.floor(Date.now()/1000);

        if (KeyGenApp.keys.s) {
          KeyGenApp.keys.e = { name: KeyGenApp.name, type: C.TYPE_RSA_ENCRYPT, data: stdin, time: c, size: ArrayUtil.bitLength(stdin.n), iden: KeyUtil.generateFingerprint(C.TYPE_RSA_ENCRYPT, stdin, c) };
          KeyGenApp.keys.e.sign = Asymmetric.sign(KeyGenApp.keys.s, KeyUtil.generateSignatureHash(KeyGenApp.keys.s, KeyGenApp.keys.e), true);

          stdout("Private Key Block", " ", KeyUtil.exportKey(KeyGenApp.keys.s, KeyGenApp.keys.e, true), " ");
          stdout("Public Key Block", " ", KeyUtil.exportKey(KeyGenApp.keys.s, KeyGenApp.keys.e), " ");

          KeyGenApp.keys = {s: null, e: null};
          KeyGenApp.name = null;
          KeyGenApp.size = null;
        } else {
          KeyGenApp.keys.s = { name: KeyGenApp.name, type: C.TYPE_RSA_SIGN, data: stdin, time: c, size: ArrayUtil.bitLength(stdin.n), iden: KeyUtil.generateFingerprint(C.TYPE_RSA_SIGN, stdin, c) };
          KeyGenApp.keys.s.sign = Asymmetric.sign(KeyGenApp.keys.s, KeyUtil.generateSignatureHash(KeyGenApp.keys.s), true);
        }

        return;
      }
    },

    printRaw: function(stdout, prompt, caller) {
      function print() {
        stdout(" ", "Your keys are being generated...", " ");
      }

      print();

      return function process(stdin) {
        for (var m in stdin)
          stdout(m+" "+ArrayUtil.toHex(stdin[m]));

        stdout(" ");

        return;
      }
    }
  }

  function Terminal(container, state) {
    var shell = container.appendChild(document.createElement("dl")),
        input = shell.appendChild(document.createElement("dt")),
        field = shell.appendChild(document.createElement("dd")),
        caret = field.appendChild(document.createElement("span")),
        clock = input.appendChild(document.createElement('span')),
        label = input.appendChild(document.createElement('span')),
        alive = false;

    function toggleCaret(highlight) {
      if (highlight || !caret.classList.contains("highlight")) {
        caret.classList.add("highlight");
      } else {
        caret.classList.remove("highlight");
      }

      if (highlight) {
        window.clearInterval(caret.timer);
        caret.timer = window.setInterval(toggleCaret, 600);
      }
    }

    function toggleLineNumbers() {
      shell.style.marginLeft = (shell.style.marginLeft == "0px") ? "-3em" : "0px";
    }

    function insertText(data, type, id) {
      var f = shell.insertBefore(document.createElement("dd"), input);
      
      if (type) f.classList.add(type);
      f.setAttribute("id", id);
      return f.appendChild(document.createTextNode(data)).textContent;
    }

    function insertLine(line, time, name, data, type) {
      var f = shell.insertBefore(document.createElement("dt"), input),
          l = f.appendChild(document.createElement("span")),
          t = f.appendChild(document.createElement("span")),
          n = f.appendChild(document.createElement("span"));
      
      l.classList.add("line");
      l.appendChild(document.createTextNode(line));
      t.appendChild(document.createTextNode(time+" "));
      n.appendChild(document.createTextNode(name));
      return insertText(data, type, line);
    }

    function clearLine() {
      if (caret.previousSibling) caret.previousSibling.remove();
      if (caret.nextSibling) caret.nextSibling.remove();
      caret.textContent = " ";
    }

    function moveLeft(remove) {
      if (!caret.previousSibling || caret.previousSibling.textContent == "") return false;
      if (!remove) {
        if (!caret.nextSibling) caret.parentNode.appendChild(document.createTextNode(""));
        caret.nextSibling.textContent = caret.textContent + caret.nextSibling.textContent;
        caret.textContent = caret.previousSibling.textContent.substring(caret.previousSibling.textContent.length - 1);
      }
      caret.previousSibling.textContent = caret.previousSibling.textContent.substring(0, caret.previousSibling.textContent.length - 1);
      return true;
    }

    function moveRight(remove) {
      if (!caret.nextSibling || caret.nextSibling.textContent == "") return false;
      if (!remove) {
        if (!caret.previousSibling) caret.parentNode.insertBefore(document.createTextNode(""), caret);
        caret.previousSibling.textContent = caret.previousSibling.textContent + caret.textContent;
      }
      caret.textContent = caret.nextSibling.textContent.substring(0, 1);
      caret.nextSibling.textContent = caret.nextSibling.textContent.substring(1);
      return true;
    }

    function control(event) {
      if (!alive) return;
      toggleCaret(true);
      switch (event.which) {
        case 13:
          event.preventDefault();
          execute();
        break;
        case 8:
          moveLeft(true);
        break;
        case 46:
          moveRight(true);
        break;
        case 37:
          if (!moveLeft()) toggleLineNumbers();
        break;
        case 39:
          moveRight();
        break;
        case 38:
          event.preventDefault();
          if (caret.pointer > 0) { 
            clearLine();
            caret.parentNode.insertBefore(document.createTextNode(shell.querySelectorAll("dd.stdin")[--caret.pointer].textContent.trim()), caret);
          }
        break;
        case 40:
          event.preventDefault();
          var lines = shell.querySelectorAll("dd.stdin");
          if (caret.pointer < lines.length) {
            clearLine();
            if (++caret.pointer < lines.length)
              caret.parentNode.insertBefore(document.createTextNode(lines[caret.pointer].textContent.trim()), caret);
          }
        break;
        case 35:
          while(moveRight());
        break;
        case 36:
          while(moveLeft());
        break;
      }
    }

    function write(event) {
      if (!alive || event.which < 32) return;
      if (!caret.previousSibling) {
        caret.parentNode.insertBefore(document.createTextNode(String.fromCharCode(event.which)), caret);
      } else {
        caret.previousSibling.textContent = caret.previousSibling.textContent + String.fromCharCode(event.which);
      }
    }

    function execute() {
      while(moveRight());
      if (caret.parentNode.textContent == " ") return;

      state = state(insertLine(caret.line++, clock.textContent, label.textContent, caret.previousSibling.textContent, "stdin").trim());

      clearLine();
      input.scrollIntoView();
    
      caret.pointer = shell.querySelectorAll("dd.stdin").length;
    }

    caret.timer = window.setInterval(toggleCaret, 600);
    caret.classList.add("nofocus");
    caret.textContent = " ";
    caret.pointer = 0;
    caret.line = 0;

    clock.date = new Date();
    clock.textContent = clock.date.toString().substring(16,24);
    clock.classList.add("clock");

    window.setInterval(function() { 
      clock.date.setTime(Date.now());
      clock.textContent = clock.date.toString().substring(16, 24);
    }, 1000);

    label.classList.add("label");

    window.addEventListener("keydown", control, true);
    window.addEventListener("keypress", write, true);
    window.addEventListener("click", function(e) { 
      alive = container.contains(e.target);
      if (alive) {
        caret.classList.remove("nofocus"); 
      } else { 
        caret.classList.add("nofocus"); 
      }
    }, true);

    state = state(function(data) { var args = Array.prototype.slice.call(arguments); while (args.length) insertText(args.shift(), "stdout"); }, 
                  function(data) { if (label.firstChild) label.removeChild(label.firstChild); label.appendChild(document.createTextNode(data)); });

    return {
      setLabel: function(text) {
        if(label.firstChild) label.removeChild(label.firstChild);
        label.appendChild(document.createTextNode(text));
      },
      read: function(line) {
        return document.getElementById(line) && document.getElementById(line).textContent.trim();
      },
      print: function(data, label) {
        return (label) ? insertLine(caret.line++, clock.textContent, label, data, "")
                       : insertText(data, "stdout");
      }
    };
  }

  var T = Terminal(document.getElementById("term"), RouterApp);
  </script>
</body>
</html>