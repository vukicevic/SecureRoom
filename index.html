<html>
<head>
  <title>SecureRoom</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link href="resources/style.css" media="all" rel="stylesheet" type="text/css">

  <script src="resources/random.default.js"></script>
  <script src="resources/symmetric.aes.cfb.js"></script>
  <script src="resources/asymmetric.rsa.js"></script>
  <script src="resources/hash.sha1.js"></script>
  <script src="resources/secureroom.js"></script>

  <script src="resources/keytools.js"></script>
  <script>
  
  function iFormatId(id) {
    return id.match(/.{2}/g).map(function(v){return v;}).join(':').toUpperCase();
  }

  function iCreateMessage(message) {
    if (message === null) return;

    var l = document.createElement('li'),
        p = document.createElement('p'),
        b = document.createElement('b'),
        d = iPrintTime(new Date(message.recvtime*1000)),
        c = app.messages++,
        i = iCreateInfo(c, message);

    l.id = 'msg'+c;
    l.className = 'msg';

    d.id = 'toggle'+c;
    d.onclick = function() { iToggleInfo(i, 0, 4.5); };

    //if a large time difference exists
    if (Math.abs(message.recvtime - message.sendtime) > 10) {
      l.className = 'alert warning';
    }

    //if recv message was sent to rejected or unknown key, attach warning
    for (var keyid in message.encrypted.keys) {
      if (typeof app.keychain[app.keymap[keyid]] == "undefined") {
        l.className = 'alert warning';
        break;
      }
    }

    //if signature is wrong
    if (!message.verified) {
      l.className = 'alert warning';
    }

    b.appendChild(document.createTextNode(app.keychain[message.sender].name+': '));
    p.appendChild(b);
    p.appendChild(document.createTextNode(message.plaintext));

    l.appendChild(d);
    l.appendChild(p);
    l.appendChild(i);

    document.getElementById('content').appendChild(l);
    window.scroll(0,document.body.offsetHeight);
  }

  function iKeyInfo(key) {
    var wrap = document.createElement('div'),
        key1 = document.createElement('p'),
        key2 = document.createElement('p');

    key1.className = 'keyinfo';
    key2.className = 'keyinfo';

    key1.appendChild(document.createElement("b"));
    key1.lastChild.appendChild(document.createTextNode(iFormatId(key.sign.id)));
    key1.appendChild(document.createElement("br"));
    key1.appendChild(document.createElement("small"));
    key1.lastChild.appendChild(document.createTextNode(key.sign.size + " BITS | " + iPrintDate(new Date(key.sign.created*1000)) + " | SIGNING"));

    wrap.appendChild(key1);

    key2.appendChild(document.createTextNode(iFormatId(key.encrypt.id)));
    key2.appendChild(document.createElement("br"));
    key2.appendChild(document.createElement("small"));
    key2.lastChild.appendChild(document.createTextNode(key.encrypt.size + " BITS |  " + iPrintDate(new Date(key.encrypt.created*1000)) + " | ENCRYPTION"));

    wrap.appendChild(key2);

    return wrap;
  }

  function iCreateProgress() {
    var li = document.getElementById('alertKeyGen'),
        di = document.createElement('div');

    while (li.firstChild) li.removeChild(li.firstChild);

    di.className = 'loading';
    li.appendChild(di);
    li.style.height = '1em';
  }

  function iCreateDistribute() {
    var li = document.getElementById('alertKeyGen'),
        h4 = document.createElement('p'),
        bu = document.createElement('span');

    li.style.height = '9em';

    while (li.firstChild) li.removeChild(li.firstChild);

    h4.appendChild(document.createTextNode('Your keys have been generated.'));

    bu.id = 'distribute';
    bu.className = 'field button';
    bu.appendChild(document.createTextNode('Connect & Distribute'));
    bu.onclick = function() {
      comm.connect();
      iSetRoom();
      iCreateProgress();
    }

    li.appendChild(h4);
    li.appendChild(iKeyInfo(app.keychain[app.myid]));
    li.appendChild(bu);

    iToggleSettings(true);
  }

  function iSetRoom() {
    if (app.room != '') {
      if (app.getRoom() == '') {
        var opts = (window.location.search) ? window.location.search+'&room=' : '?room=',
            path = (window.location.pathname.substr(window.location.pathname.lastIndexOf('/')+1) == 'index.html') ? window.location.pathname+opts+app.room : window.location.pathname+app.room;
        window.history.replaceState({} , 'SecureRoom', path);
      }
      document.getElementById('room').innerHTML = 'Room: '+app.room;
    }
  }

  function iConnect() {
    var li = document.getElementById('alertKeyGen'),
        di = iPrintTime(new Date());

    while (li.firstChild) li.removeChild(li.firstChild);

    di.onclick = function() { iToggleInfo(li, 1, 6); }
    
    li.appendChild(document.createTextNode('Connected.'));
    li.appendChild(di);
    li.appendChild(iKeyInfo(app.keychain[app.myid]));
    
    li.style.height = '1em';
  }
  
  function iDisconnect() {
    var li = document.createElement('li'),
        di = iPrintTime(new Date());

    li.className = 'alert';
    li.appendChild(document.createTextNode('Disconnected.'));
    li.appendChild(di);
    
    document.getElementById('content').appendChild(li);
  }

  function iCreateReceive(key) {
    if (document.getElementById('alert'+key.sign.id)) return;

    var li = document.createElement('li'),
        pa = document.createElement('p'),
        ba = document.createElement('span'),
        br = document.createElement('span'),
        di = document.createElement('div');

    li.className = 'alert clear';
    li.id        = 'alert'+key.sign.id;
    document.getElementById('content').appendChild(li);

    di.className = 'time';
    pa.appendChild(document.createTextNode(key.name+' wants to join. Do you accept?'));

    ba.className = 'field button';
    br.className = 'field button';

    ba.appendChild(document.createTextNode('Accept'));
    ba.onclick = function() {
      key.active = true;
      app.keychain[key.sign.id] = key;
      app.keymap[key.encrypt.id] = key.sign.id;
      iRefreshKeychain();
      iCreateReceived(this, key);
      comm.sendKey();
    }

    br.appendChild(document.createTextNode('Reject'));
    br.onclick = function() {
      key.active = false;
      app.rejected[key.sign.id] = key;
      app.keymap[key.encrypt.id] = key.sign.id;
      iCreateReceived(this, key, true);
    }

    li.appendChild(pa);
    li.appendChild(iKeyInfo(key));
    li.appendChild(ba);
    li.appendChild(br);

    li.style.height = '9em';
    window.scroll(0,document.body.offsetHeight);
  }

  function iCreateReceived(control, key, reject) {
    var alert = control.parentNode,
        info = iPrintTime(new Date());

    while (alert.firstChild) alert.removeChild(alert.firstChild);
    alert.style.height = '1em';
    if (reject) {
      alert.appendChild(document.createTextNode(key.name+'\'s key rejected.'));
      alert.className = 'alert warning';
    } else {
      alert.appendChild(document.createTextNode(key.name+' joined.'));
    }
    info.className += ' down';
    info.onclick = function() { iToggleInfo(alert, 1, 6); };
    alert.appendChild(info);
    alert.appendChild(iKeyInfo(key));
  }
  
  function iCreateInfo(id, message) {
    var div  = document.createElement('div'), m = 8192,
        info = '';

    div.className = 'msginfo';
    div.id = 'info'+id;

    info += ' <b>Sent By:</b> '+iFormatId(message.sender);
    info += ' <b>At:</b> '+iPrintDate(new Date(message.sendtime*1000));
    info += ' <b>Verified:</b> ';
    info += (message.verified) ? 'True<br>' : '<u>False</u><br>';

    info += ' <b>Sent To:</b> ';
    for (keyid in message.encrypted.keys) {
      info += iFormatId(keyid);
      if (typeof app.keychain[app.keymap[keyid]] != "undefined") {
        info += ' ['+app.keychain[app.keymap[keyid]].name.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi, '')+'] ';
        m = Math.min(app.keychain[app.keymap[keyid]].encrypt.size, m);
      } else if (typeof app.rejected[app.keymap[keyid]] != "undefined") {
        info += ' [<b>REJECTED</b>] ';
        m = 0;
      } else {
        info += ' [<b>UNKNOWN</b>] ';
        m = 0;
      }
    }
    info += (m==8192) ? '&#8212;<br>' : '<br>';

    info += ' <b>Cipher:</b> '+symmetric.name+'-'+(message.sessionkey.length*8)+' ['+symmetric.mode+']';
    info += ' <b>Weakest key:</b> ';
    info += (m>0&&m<8192) ? m+' bits' : 'Unknown';

    div.innerHTML = info;
    return div;
  }

  function iPrintDate(date) {
    return date.getHours()+':'+('0'+date.getMinutes()).slice(-2)+':'+('0'+date.getSeconds()).slice(-2)+' '+date.getDate()+'/'+(date.getMonth()+1)+'/'+date.getFullYear();
  }
  
  function iPrintTime(date) {
    var d = document.createElement('div');
    d.className = 'time';
    d.innerHTML = ('0'+date.getHours()).slice(-2)+' '+('0'+date.getMinutes()).slice(-2)+' '+('0'+date.getSeconds()).slice(-2);
    return d;
  }

  function iShowInput() {
    var i = document.getElementById('input'),
        m = document.getElementById('message'),
        s = document.getElementById('send'),
        k = document.getElementById('toggleKeychain');

    m.style.width = (i.offsetWidth-(s.offsetWidth+k.offsetWidth+50))+'px';
    i.style.bottom = '0';
    m.focus();
  }
  
  function iHideInput() {
    document.getElementById('input').style.bottom = '-2.7em';
  }

  function iRefreshKeychain() {
    var kc = document.getElementById('keychain'),
        li, nm, b1, b2, pu, pr, tu, tr, ct;

    while (kc.firstChild) kc.removeChild(kc.firstChild);

    for (keyid in app.keychain) {
      li = document.createElement('li');
      pu = document.createElement('div');
      tu = document.createElement('textarea');
      nm = document.createElement('h3');
      ct = document.createElement('div');
      b1 = document.createElement('span');
      b2 = document.createElement('span');

      if (app.myid != keyid) {
        if (app.keychain[keyid].active) {
          b1.innerHTML = 'ACTIVE';
        } else {
          li.className = 'inactive';
          b1.className = 'inactive';
          b1.innerHTML = 'DISABLED';
        }
        
        b1.onclick = function(elem, ctrl) { 
                      return function() { iToggleKey(elem, ctrl); } 
                     }(li, b1);

        b1.id = 'switch'+keyid;
      } else {
        li.className = 'mykey';
        
        tr = document.createElement('textarea');
        tr.innerHTML = KeyTools.exportKey(app.keychain[keyid].name, app.keychain[keyid].sign, app.keychain[keyid].encrypt, app.signkey.mpi, app.encryptkey.mpi);

        pr = document.createElement('div');
        pr.appendChild(tr);
        pr.className     = 'export';
        pr.style.display = 'none';

        b1.innerHTML = 'PRIVATE KEY';
        b1.onclick = function(elem, ctrl) { 
          return function() { iToggleExport(elem, ctrl); }
        }(pr, b1);

        li.appendChild(pr);
      }
      
      li.id = keyid;
      ct.className = 'controls';

      tu.innerHTML     = KeyTools.exportKey(app.keychain[keyid].name, app.keychain[keyid].sign, app.keychain[keyid].encrypt);
      pu.appendChild(tu);
      pu.className     = 'export';
      pu.style.display = 'none';

      b2.innerHTML = 'PUBLIC KEY';
      b2.onclick = function(elem, ctrl) { 
        return function() { iToggleExport(elem, ctrl); }
      }(pu, b2);

      ct.appendChild(b1);
      ct.appendChild(b2);
      nm.appendChild(document.createTextNode(app.keychain[keyid].name));

      li.appendChild(pu);
      li.appendChild(nm);
      li.appendChild(ct);
      li.appendChild(iKeyInfo(app.keychain[keyid]));

      kc.appendChild(li);
    }

    iToggleKeychain(true);
  }

  function iSendMessage() {
    var i = document.getElementById('message'),
        b = document.getElementById('send');

    if (i.textContent.length > 0) {
      b.style.backgroundColor = '#f00';
      UiUtil.addMessage(comm.sendMessage(i.textContent));
      i.innerHTML = '';
      window.setTimeout(function() {b.style.backgroundColor = '#fff'}, '50');
    }
  }

  function iSetSize(elem) {
    while(elem.parentNode.getElementsByClassName('selected').length)
      elem.parentNode.getElementsByClassName('selected')[0].className = '';
    elem.className = 'selected';
    return parseInt(elem.textContent);
  }

  function iDisableSettings() {
    for (var i = 0, n = document.getElementById('asymsize').querySelectorAll('span'); i < n.length; i++) {
      if (n[i].className == 'selected') {
        n[i].onclick = null;
        n[i].className = 'disabled';
      } else {
        n[i].parentNode.removeChild(n[i]);
      }
    }

    var server = document.getElementById("serverurl");
    server.className = 'disabled';
    server.contentEditable = false;
  }

  function iGenerate() {
    app.generateKeys(document.getElementById('nickname').textContent);
    iCreateProgress();
    iDisableSettings();
  }

  function iToggleSettings(close) {
    var button = document.getElementById('toggleSettings'),
        menu   = document.getElementById('settings');

    if (button.className == 'open' || close) {
      window.scroll(0, document.body.offsetHeight);
      button.className = 'closed';
      menu.style.marginTop = '-'+(menu.clientHeight-button.clientHeight)+'px';
    } else {
      window.scrollTo(0, 0);
      button.className = 'open';
      menu.style.marginTop = '3em';
    }
  }

  function iToggleKeychain(close) {
    var button = document.getElementById('toggleKeychain'),
        menu = document.getElementById('keychain');

    if (button.className == 'open' || close) {
      button.className = 'closed';
      menu.style.bottom = '-'+menu.clientHeight+'px';
      
      for (var i = 0, e = menu.getElementsByClassName('export'); i < e.length; i++)
        e[i].style.display = 'none';

      while (menu.getElementsByClassName('selected').length)
        menu.getElementsByClassName('selected')[0].className = '';

    } else {
      button.className = 'open';
      menu.style.bottom = (button.clientHeight-5)+'px';
    }
  }

  function iToggleKey(key, button) {
    if (app.keychain[key.id].active) {
      button.className = 'inactive';
      button.innerHTML = 'DISABLED';
      key.className = 'inactive';
      app.keychain[key.id].active = false;
    } else {
      button.className = '';
      button.innerHTML = 'ACTIVE';
      key.className = '';
      app.keychain[key.id].active = true;
    }
  }

  function iToggleInfo(elem, min, max) {
    elem.style.height = (elem.style.height == max+'em') ? min+'em' : max+'em';
  }

  function iToggleExport(elem, button) {
    if (elem.style.display == 'none') {
      elem.style.display = 'block';
      button.className = 'selected';
    } else {
      elem.style.display = 'none';
      button.className = '';
    }
    
    elem.style.left = (elem.parentNode.getBoundingClientRect().left - 1)+'px';
    elem.style.top  = '-'+(elem.offsetHeight - (elem.parentNode.getBoundingClientRect().top - elem.parentNode.parentNode.getBoundingClientRect().top))+'px';
  }

  function TemplateTools(templ) {
    if (typeof templ != "undefined")
      templ = document.getElementById(templ).innerHTML.replace(/\n|\r/g, "").replace(/>\s+</g, "><").trim();

    return function compile(data, template) {
      var match, tpart, i, template = template || templ;

      while (match = /\{\{#([a-zA-Z]+)\}\}(.+)\{\{\/\1\}\}/g.exec(template)) {
        for (tpart = '', i = 0; i < data[match[1]].length; i++)
          tpart += compile(data[match[1]][i], match[2]);

        template = template.split(match[0]).join(tpart);
        delete data[match[1]];
      }

      for (match in data)
        template = template.split('{{'+match+'}}').join(data[match]);

      return template;
    }
  }

  var PrintUtil = {
    time: function(timestamp) {
      var date = new Date(timestamp*1000);
      return ('0'+date.getHours()).slice(-2)+' '+('0'+date.getMinutes()).slice(-2)+' '+('0'+date.getSeconds()).slice(-2);
    },

    date: function(timestamp) {
      var date = new Date(timestamp*1000);
      return date.getHours()+':'+('0'+date.getMinutes()).slice(-2)+':'+('0'+date.getSeconds()).slice(-2)+' '+date.getDate()+'/'+(date.getMonth()+1)+'/'+date.getFullYear();
    },

    text: function(text) {
      return text.replace(/["<>&]/g, function(m){return ({'"':'&quot;','<':'&lt;','>':'&gt;','&':'&amp;'})[m]});
    },

    bool: function(boolean) {
      return (boolean) ? 'True' : 'False';
    },

    number: function(number) {
      return number.toString();
    },

    id: function(id) {
      return id.match(/.{2}/g).map(function(v){return v;}).join(':').toUpperCase();
    }
  }

  function MessageTools(message) {
    return {
      strength: function() {
        var key, min = 8192;

        for (key in message.encrypted.keys) {
          if (typeof app.keychain[app.keymap[key]] == "undefined") {
            min = 8192;
            break;
          }
          min = Math.min(app.keychain[app.keymap[key]].encrypt.size, min);
        }

        return {
          term: 'Weakest Key',
          data: (min < 8192) ? min+' bits' : 'Unknown',
        };
      },

      recipients: function() {
        var key, list = '';

        for (key in message.encrypted.keys) {
          if (list) 
            list += ', ';
          if (typeof app.keychain[app.keymap[key]] != "undefined") {
            list += PrintUtil.text(app.keychain[app.keymap[key]].name);
          } else {
            list += (typeof app.rejected[app.keymap[key]] != "undefined") ? 'Rejected' : 'Unknown';
          }
        }

        return {
          term: 'Recipients',
          data: list
        };
      },

      cipher: function() {
        return {
          term: 'Cipher',
          data: symmetric.name+'-'+(message.sessionkey.length*8)+' ['+symmetric.mode+']'
        };
      },

      delay: function() {
        var diff = message.recvtime - message.sendtime;

        if (diff >= 0)
          diff = '+'+diff;

        return {
          term: 'Delay',
          data: diff+' sec'
        };
      },

      verified: function() {
        return {
          term: 'Verified',
          data: PrintUtil.bool(message.verified)
        };
      },

      sender: function() {
        return {
          term: 'Author',
          data: PrintUtil.id(message.sender)
        };
      }
    }
  }

  var UiUtil = {
    toggleHeight: function(elem) {
      var height = elem.offsetHeight;

      if (elem.classList.contains('hidden-height')) {
        elem.style.height = '0px';
        elem.classList.remove('hidden-height');
      } else {
        elem.style.height = height+'px';
      }

      return function() {
        elem.style.height = (elem.style.height == '0px') ? height+'px' : '0px';
      }
    },

    removeContent: function(elem) {
      return function() {
        while (elem.firstChild) elem.removeChild(elem.firstChild);
      }
    },

    addMessage: function(message) {
      var container = document.getElementById('content'),
          build = TemplateTools('template-message'),
          content = {};

      content.id      = PrintUtil.number(app.messages++);
      content.time    = PrintUtil.time(message.recvtime);
      content.sender  = PrintUtil.text(app.keychain[message.sender].name);
      content.message = PrintUtil.text(message.plaintext);
      content.info    = UiUtil.buildMsgInfo(MessageTools(message));
      content.class   = (!message.verified) ? ' warning' : '';

      container.insertAdjacentHTML('beforeend', build(content));

      var e = document.getElementById('message-'+content.id);
      e.addEventListener('click', UiUtil.toggleHeight(e.getElementsByClassName('info').item(0)));
    },

    addKey: function(key) {
      var container = document.getElementById('content'),
          build = TemplateTools('template-key-alert'),
          content = {};

      content.id      = PrintUtil.number(app.messages++);
      content.time    = PrintUtil.time(Math.round(+new Date()/1000));
      content.message = PrintUtil.text(key.name+' has joined.');
      content.info    = UiUtil.buildKeyInfo(key);

      container.insertAdjacentHTML('beforeend', build(content));

      var e = document.getElementById('alert-'+content.id),
          a = e.getElementsByTagName('span').item(0),
          r = e.getElementsByTagName('span').item(1),
          i = e.getElementsByClassName('info').item(0);

      e.addEventListener('click', UiUtil.toggleHeight(i));

      a.addEventListener('click', function() { 
        key.active = true;
        app.keychain[key.sign.id] = key;
        app.keymap[key.encrypt.id] = key.sign.id;
        comm.sendKey();
      });

      a.addEventListener('click', UiUtil.removeContent(a.parentNode));

      r.addEventListener('click', function() { 
        key.active = false;
        app.rejected[key.sign.id] = key;
        app.keymap[key.encrypt.id] = key.sign.id;
      });

      r.addEventListener('click', UiUtil.removeContent(r.parentNode));
    },

    buildMsgInfo: function(messageTool) {
      var build = TemplateTools('template-message-info'),
          content = {info: []};

      content.info.push(messageTool.verified());
      content.info.push(messageTool.sender());
      content.info.push(messageTool.recipients());
      content.info.push(messageTool.cipher());
      content.info.push(messageTool.delay());
      content.info.push(messageTool.strength());

      return build(content);
    },

    buildKeyInfo: function(key, hidden) {
      var build = TemplateTools('template-key-info'),
          content = {};

      content.class = (hidden) ? ' hidden-height' : '';

      content.sid   = PrintUtil.id(key.sign.id);
      content.ssize = PrintUtil.number(key.sign.size);
      content.sdate = PrintUtil.date(key.sign.created);

      content.eid   = PrintUtil.id(key.encrypt.id);
      content.esize = PrintUtil.number(key.encrypt.size);
      content.edate = PrintUtil.date(key.encrypt.created);

      return build(content);
    }
  }
  </script>

  <script type="text/html" id="template-message">
    <li id="message-{{id}}" class="message{{class}}">
      <div class="time">{{time}}</div>
      <p><b class="cln">{{sender}}</b>{{message}}</p>
      {{info}}
    </li>
  </script>

  <script type="text/html" id="template-message-info">
    <ul class="info hidden-height">
      {{#info}}
      <li><b class="cln">{{term}}</b>{{data}}</li>
      {{/info}}
    </ul>
  </script>

  <script type="text/html" id="template-key-alert">
    <li id="alert-{{id}}" class="alert">
      <div class="time">{{time}}</div>
      <p>{{message}}</p>
      {{info}}
      <div class="options clear">
        <span class="field button">Accept</span> <span class="field button">Reject</span>
      </div>
    </li>
  </script>

  <script type="text/html" id="template-key-info">
    <div class="info{{class}}">
      <p><b>{{sid}}</b><br><small>{{ssize}} | {{sdate}} | SIGNING</small></p>
      <p>{{eid}}<br><small>{{esize}} | {{edate}} | ENCRYPTION</small></p>
    </div>
  </script>
</head>
<body>
  <div id="menu">
    <span class="open" id="toggleSettings" onclick="iToggleSettings();">
    <svg height="19" width="16" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <rect y="3" width="16" height="3" />
      <rect y="8" width="16" height="3" />
      <rect y="13" width="16" height="3" />
    </svg>
    </span>
    <span id="room">Room: -</span>
  </div>

  <ul id="settings">
    <li>
      <h3>Symmetric Cipher (AES)</h3>
      <div class="controls">Size (bits): <span class="selected" onclick="app.ciphersize=iSetSize(this)">128</span><span onclick="app.ciphersize=iSetSize(this)">192</span><span onclick="app.ciphersize=iSetSize(this)">256</span></div>
    </li>
    <li>
      <h3>Asymmetric Key (RSA)</h3>
      <div class="controls" id="asymsize">Size (bits): <span class="selected" onclick="app.keysize=iSetSize(this)">1024</span><span onclick="app.keysize=iSetSize(this)">1536</span><span onclick="app.keysize=iSetSize(this)">2048</span></div>
    </li>
    <li>
      <h3>WebSocket Connection</h3>
      <div class="controls">URL: <span id="serverurl" contenteditable="true" onkeydown="if(event.keyCode === 13)event.preventDefault();" onkeyup="app.server=this.textContent;"></span></div>
    </li>
  </ul>

  <ul id="content">
    <li class="alert clear" id="alertKeyGen">
      <p>Enter a nickname.</p>
      <span class="field" id="nickname" contenteditable="true" onkeyup="document.getElementById('generate').style.display=(this.textContent.length<3)?'none':'block';"
      onkeypress="if(event.keyCode === 13) { event.preventDefault(); if(this.textContent.length>=3){iGenerate();}}"></span>
      <span class="field button" id="generate" onclick="iGenerate();">Generate</span>
    </li>
  </ul>

  <div id="input">
    <span class="field" id="message" contenteditable="true" onkeydown="if(event.keyCode === 13){event.preventDefault(); iSendMessage();}"></span>
    <span class="field button" id="send" onclick="iSendMessage();">Send</span>
    <span class="closed" id="toggleKeychain" onclick="iToggleKeychain();">
    <svg height="19" width="12" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <rect y="3" width="4" height="3" />
      <rect y="8" width="4" height="3" />
      <rect y="13" width="4" height="3" />
    </svg>
    </span>
  </div>

  <ul id="keychain">
  </ul>

  <script>
  if (typeof window.crypto.getRandomValues === 'function' && typeof window.WebSocket === 'function' && typeof window.Worker === 'function') {
    app.setCallbacks(
      function() {
        iCreateDistribute();
        iSetRoom();
      }
    )

    comm.setCallbacks(
      function() {
        iConnect();
        iShowInput();
        iRefreshKeychain();
      },
      function() {
        iDisconnect();
        iHideInput();
      },
      function(msg) {
        UiUtil.addMessage(msg);
      },
      function(key) {
        //iCreateReceive(key);
        UiUtil.addKey(key);
      }
    )
    
    window.onload = function() {
      app.server = app.getServer();
      app.room = app.getRoom();
      
      iSetRoom();
      document.getElementById("serverurl").innerHTML = app.server;
      document.getElementById("nickname").focus();
    }

    window.onresize = function(event) {
      if (comm.connected) {
        iShowInput();
        iToggleKeychain(true);
      }
      iToggleSettings(true);
    }
  } else {
    alert('Unfortunately, your browser does not have the necessary features to run this application. Please try Firefox 21+ or Chrome 11+.');
  }
  </script>
</body>
</html>
