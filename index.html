<html>
<head>
  <title>SecureRoom</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link href="resources/style.css" media="all" rel="stylesheet" type="text/css">

  <script src="resources/random.default.js"></script>
  <script src="resources/symmetric.aes.cfb.js"></script>
  <script src="resources/asymmetric.rsa.js"></script>
  <script src="resources/hash.sha1.js"></script>
  <script src="resources/secureroom.js"></script>

  <script src="resources/keytools.js"></script>
  <script>

  function iSetRoom() {
    if (app.room != '') {
      if (app.getRoom() == '') {
        var opts = (window.location.search) ? window.location.search+'&room=' : '?room=',
            path = (window.location.pathname.substr(window.location.pathname.lastIndexOf('/')+1) == 'index.html') ? window.location.pathname+opts+app.room : window.location.pathname+app.room;
        window.history.replaceState({} , 'SecureRoom', path);
      }
      document.getElementById('room').innerHTML = 'Room: '+app.room;
    }
  }

  function iShowInput() {
    var i = document.getElementById('input'),
        m = document.getElementById('message'),
        s = document.getElementById('send'),
        k = document.getElementById('toggleKeychain');

    m.style.width = (i.offsetWidth-(s.offsetWidth+k.offsetWidth+50))+'px';
    i.style.bottom = '0';
    m.focus();
  }
  
  function iHideInput() {
    document.getElementById('input').style.bottom = '-2.7em';
  }

  function iSendMessage() {
    var i = document.getElementById('message'),
        b = document.getElementById('send');

    if (i.textContent.length > 0) {
      b.style.backgroundColor = '#f00';
      UiUtil.addMessage(comm.sendMessage(i.textContent));
      i.innerHTML = '';
      window.setTimeout(function() {b.style.backgroundColor = '#fff'}, '50');
    }
  }

  function iSetSize(elem) {
    while(elem.parentNode.getElementsByClassName('selected').length)
      elem.parentNode.getElementsByClassName('selected')[0].className = '';
    elem.className = 'selected';
    return parseInt(elem.textContent);
  }

  function iDisableSettings() {
    for (var i = 0, n = document.getElementById('asymsize').querySelectorAll('span'); i < n.length; i++) {
      if (n[i].className == 'selected') {
        n[i].onclick = null;
        n[i].className = 'disabled';
      } else {
        n[i].parentNode.removeChild(n[i]);
      }
    }

    var server = document.getElementById("serverurl");
    server.className = 'disabled';
    server.contentEditable = false;
  }

  function iToggleSettings(close) {
    var button = document.getElementById('toggleSettings'),
        menu   = document.getElementById('settings');

    if (button.className == 'open' || close) {
      window.scroll(0, document.body.offsetHeight);
      button.className = 'closed';
      menu.style.marginTop = '-'+(menu.clientHeight-button.clientHeight)+'px';
    } else {
      window.scrollTo(0, 0);
      button.className = 'open';
      menu.style.marginTop = '3em';
    }
  }

  function iToggleKeychain(close) {
    var button = document.getElementById('toggleKeychain'),
        menu = document.getElementById('keychain');

    if (button.className == 'open' || close) {
      button.className = 'closed';
      menu.style.bottom = '-'+menu.clientHeight+'px';
      
      for (var i = 0, e = menu.getElementsByClassName('export'); i < e.length; i++)
        e[i].style.display = 'none';

      while (menu.getElementsByClassName('selected').length)
        menu.getElementsByClassName('selected')[0].className = '';

    } else {
      button.className = 'open';
      menu.style.bottom = (button.clientHeight-5)+'px';
    }
  }

  /*function iToggleKey(key, button) {
    if (app.keychain[key.id].active) {
      button.className = 'inactive';
      button.innerHTML = 'DISABLED';
      key.className = 'inactive';
      app.keychain[key.id].active = false;
    } else {
      button.className = '';
      button.innerHTML = 'ACTIVE';
      key.className = '';
      app.keychain[key.id].active = true;
    }
  }

  function iToggleExport(elem, button) {
    if (elem.style.display == 'none') {
      elem.style.display = 'block';
      button.className = 'selected';
    } else {
      elem.style.display = 'none';
      button.className = '';
    }
    
    elem.style.left = (elem.parentNode.getBoundingClientRect().left - 1)+'px';
    elem.style.top  = '-'+(elem.offsetHeight - (elem.parentNode.getBoundingClientRect().top - elem.parentNode.parentNode.getBoundingClientRect().top))+'px';
  }*/

  function TemplateTools(templ) {
    if (typeof templ != "undefined")
      templ = document.getElementById(templ).innerHTML.replace(/\n|\r/g, "").replace(/>\s+</g, "><").trim();

    return function compile(data, template) {
      var match, tpart, i, template = template || templ;

      while (match = /\{\{#([a-zA-Z]+)\}\}(.+)\{\{\/\1\}\}/g.exec(template)) {
        for (tpart = '', i = 0; i < data[match[1]].length; i++)
          tpart += compile(data[match[1]][i], match[2]);

        template = template.split(match[0]).join(tpart);
        delete data[match[1]];
      }

      for (match in data)
        template = template.split('{{'+match+'}}').join(data[match]);

      return template;
    }
  }

  var PrintUtil = {
    time: function(timestamp) {
      var date = new Date(timestamp*1000);
      return ('0'+date.getHours()).slice(-2)+' '+('0'+date.getMinutes()).slice(-2)+' '+('0'+date.getSeconds()).slice(-2);
    },

    date: function(timestamp) {
      var date = new Date(timestamp*1000);
      return date.getHours()+':'+('0'+date.getMinutes()).slice(-2)+':'+('0'+date.getSeconds()).slice(-2)+' '+date.getDate()+'/'+(date.getMonth()+1)+'/'+date.getFullYear();
    },

    text: function(text) {
      return text.replace(/["<>&]/g, function(m){return ({'"':'&quot;','<':'&lt;','>':'&gt;','&':'&amp;'})[m]});
    },

    bool: function(boolean) {
      return (boolean) ? 'True' : 'False';
    },

    number: function(number) {
      return number.toString();
    },

    id: function(id) {
      return id.match(/.{2}/g).map(function(v){return v;}).join(':').toUpperCase();
    }
  }

  function MessageTools(message) {
    return {
      strength: function() {
        var key, min = 8192;

        for (key in message.encrypted.keys) {
          if (typeof app.keychain[app.keymap[key]] == "undefined") {
            min = 8192;
            break;
          }
          min = Math.min(app.keychain[app.keymap[key]].encrypt.size, min);
        }

        return {
          term: 'Weakest Key',
          data: (min < 8192) ? min+' bits' : 'Unknown',
        };
      },

      recipients: function() {
        var key, list = '';

        for (key in message.encrypted.keys) {
          if (list) 
            list += ', ';
          if (typeof app.keychain[app.keymap[key]] != "undefined") {
            list += PrintUtil.text(app.keychain[app.keymap[key]].name);
          } else {
            list += (typeof app.rejected[app.keymap[key]] != "undefined") ? 'Rejected' : 'Unknown';
          }
        }

        return {
          term: 'Recipients',
          data: list
        };
      },

      cipher: function() {
        return {
          term: 'Cipher',
          data: symmetric.name+'-'+(message.sessionkey.length*8)+' ['+symmetric.mode+']'
        };
      },

      delay: function() {
        var diff = message.recvtime - message.sendtime;

        if (diff >= 0)
          diff = '+'+diff;

        return {
          term: 'Delay',
          data: diff+' sec'
        };
      },

      verified: function() {
        return {
          term: 'Verified',
          data: PrintUtil.bool(message.verified)
        };
      },

      sender: function() {
        return {
          term: 'Author',
          data: PrintUtil.id(message.sender)
        };
      }
    }
  }

  var UiUtil = {
    toggleHeight: function(elem) {
      var height = elem.offsetHeight;

      if (elem.classList.contains('hidden-height')) {
        elem.style.height = '0px';
        elem.classList.remove('hidden-height');
      } else {
        elem.style.height = height+'px';
      }

      return function() {
        elem.style.height = (elem.style.height == '0px') ? height+'px' : '0px';
      }
    },

    removeContent: function(elem) {
      elem.style.height = elem.offsetHeight+'px';

      return function() {
        elem.style.height = '0px';
        while (elem.firstChild) elem.removeChild(elem.firstChild);
      }
    },

    addMessage: function(message) {
      var container = document.getElementById('content'),
          build = TemplateTools('template-message'),
          content = {};

      content.id      = PrintUtil.number(app.messages++);
      content.time    = PrintUtil.time(message.recvtime);
      content.sender  = PrintUtil.text(app.keychain[message.sender].name);
      content.message = PrintUtil.text(message.plaintext);
      content.info    = UiUtil.buildMsgInfo(MessageTools(message));
      content.class   = (!message.verified) ? ' warning' : '';

      container.insertAdjacentHTML('beforeend', build(content));

      UiUtil.addMessageListeners(document.getElementById('message-'+content.id));
    },

    addMessageListeners: function(e) {
      e.addEventListener('click', UiUtil.toggleHeight(e.getElementsByClassName('info').item(0)));
    },

    addKey: function(key) {
      var container = document.getElementById('content'),
          build = TemplateTools('template-key-alert'),
          content = {};

      content.id   = PrintUtil.number(app.messages++);
      content.time = PrintUtil.time(Math.round(+new Date()/1000));
      content.name = PrintUtil.text(key.name);
      content.info = UiUtil.buildKeyInfo(key);

      container.insertAdjacentHTML('beforeend', build(content));

      UiUtil.addKeyListeners(document.getElementById('alert-'+content.id), key);
    },

    addKeyListeners: function(e, key) {
      var a = e.getElementsByTagName('button').item(0),
          r = e.getElementsByTagName('button').item(1),
          p = e.getElementsByClassName('join').item(0),
          d = UiUtil.removeContent(a.parentNode);

      a.addEventListener('click', function() { 
        key.active = true;
        app.keychain[key.sign.id] = key;
        app.keymap[key.encrypt.id] = key.sign.id;
        comm.sendKey();
      });

      a.addEventListener('click', function() { 
        p.classList.remove('join');
        p.classList.add('accept');
        UiUtil.buildKeyChain();
      });

      a.addEventListener('click', d);

      r.addEventListener('click', function() { 
        key.active = false;
        app.rejected[key.sign.id] = key;
        app.keymap[key.encrypt.id] = key.sign.id;
      });

      r.addEventListener('click', function() { 
        e.classList.add('warning');
        p.classList.remove('join');
        p.classList.add('reject');
      });
      
      r.addEventListener('click', d);
    },

    buildMsgInfo: function(messageTool) {
      var build = TemplateTools('template-message-info'),
          content = {info: []};

      content.info.push(messageTool.verified());
      content.info.push(messageTool.sender());
      content.info.push(messageTool.recipients());
      content.info.push(messageTool.cipher());
      content.info.push(messageTool.delay());
      content.info.push(messageTool.strength());

      return build(content);
    },

    buildKeyInfo: function(key) {
      var build = TemplateTools('template-key-info'),
          content = {};

      content.sid   = PrintUtil.id(key.sign.id);
      content.ssize = PrintUtil.number(key.sign.size);
      content.sdate = PrintUtil.date(key.sign.created);

      content.eid   = PrintUtil.id(key.encrypt.id);
      content.esize = PrintUtil.number(key.encrypt.size);
      content.edate = PrintUtil.date(key.encrypt.created);

      return build(content);
    },

    buildKeyChain: function() {
      var container = document.getElementById('keychain'),
          build = TemplateTools('template-key-chain'),
          content = {};

      while (container.lastChild != container.firstChild) container.removeChild(container.lastChild);

      for (var id in app.keychain) {
        if (app.myid != id) {
          content.id     = PrintUtil.text(id);
          content.name   = PrintUtil.text(app.keychain[id].name);
          content.status = (app.keychain[id].active) ? '' : 'inactive';
          content.info   = UiUtil.buildKeyInfo(app.keychain[id]);

          container.insertAdjacentHTML('beforeend', build(content));
        }
      }
    },

    addWelcome: function(type) {
      var container = document.getElementById('welcome');
      while (container.firstChild) container.removeChild(container.firstChild);
      
      switch(type) {
      case 'distribute':
        container.insertAdjacentHTML('beforeend', '<p>Your keys have been generated.</p><div class="info">'+UiUtil.buildKeyInfo(app.keychain[app.myid])+'</div><button>Connect &amp; Distribute</button>');
        container.getElementsByTagName('button').item(0).addEventListener('click', function() { comm.connect(); iSetRoom(); UiUtil.addWelcome('progress') });
        break;
      case 'progress':
        container.insertAdjacentHTML('beforeend', '<div class="loading"></div>');
        break;
      case 'connect':
        container.insertAdjacentHTML('beforeend', '<div class="time">'+PrintUtil.time(Math.round(+new Date()/1000))+'</div><p>Connected.</p>');
        break;
      case 'disconnect':
        container.insertAdjacentHTML('beforeend', '<div class="time">'+PrintUtil.time(Math.round(+new Date()/1000))+'</div><p>Disconnected.</p>');
        break;   
      }
    }
  }
  </script>

  <script type="text/html" id="template-message">
    <li id="message-{{id}}" class="message{{class}}">
      <div class="time">{{time}}</div>
      <p><b class="cln">{{sender}}</b>{{message}}</p>
      {{info}}
    </li>
  </script>

  <script type="text/html" id="template-message-info">
    <ul class="info hidden-height">
      {{#info}}
      <li><b class="cln">{{term}}</b>{{data}}</li>
      {{/info}}
    </ul>
  </script>

  <script type="text/html" id="template-key-alert">
    <li id="alert-{{id}}" class="alert">
      <div class="time">{{time}}</div>
      <p class="join">{{name}}</p>
      <div class="info">
        {{info}}
        <button>Accept</button><button>Reject</button>
      </div>
    </li>
  </script>

  <script type="text/html" id="template-key-info">
    <p><b>{{sid}}</b><br><small>{{ssize}} | {{sdate}} | SIGNING</small></p>
    <p>{{eid}}<br><small>{{esize}} | {{edate}} | ENCRYPTION</small></p>
  </script>

  <script type="text/html" id="template-key-chain">
    <li id="key-{{id}}">
      <div class="export" style="display: none;"><textarea>...</textarea></div>
      <h3>{{name}}</h3>
      <div class="controls"><span class="{{status}}">ACTIVE</span><span>PUBLIC KEY</span></div>
      <div class="info">{{info}}</div>
    </li>
  </script>
</head>
<body>
  <div id="menu">
    <span class="open" id="toggleSettings" onclick="iToggleSettings();">
    <svg height="19" width="16" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <rect y="3" width="16" height="3" />
      <rect y="8" width="16" height="3" />
      <rect y="13" width="16" height="3" />
    </svg>
    </span>
    <span id="room">Room: -</span>
  </div>

  <ul id="settings">
    <li>
      <h3>Symmetric Cipher (AES)</h3>
      <div class="controls">Size (bits): <span class="selected" onclick="app.ciphersize=iSetSize(this)">128</span><span onclick="app.ciphersize=iSetSize(this)">192</span><span onclick="app.ciphersize=iSetSize(this)">256</span></div>
    </li>
    <li>
      <h3>Asymmetric Key (RSA)</h3>
      <div class="controls" id="asymsize">Size (bits): <span class="selected" onclick="app.keysize=iSetSize(this)">1024</span><span onclick="app.keysize=iSetSize(this)">1536</span><span onclick="app.keysize=iSetSize(this)">2048</span></div>
    </li>
    <li>
      <h3>WebSocket Connection</h3>
      <div class="controls">URL: <span id="serverurl" contenteditable="true" onkeydown="if(event.keyCode === 13)event.preventDefault();" onkeyup="app.server=this.textContent;"></span></div>
    </li>
  </ul>

  <ul id="content">
    <li class="alert" id="welcome">
      <input type="text" id="nickname" autocomplete="off" placeholder="Enter a nickname..." onkeyup="this.nextSibling.disabled=(this.value.length<3);" onkeypress="(event.keyCode===13) && this.nextSibling.onclick();"><button onclick="if (!this.disabled) { app.generateKeys(this.previousSibling.value); UiUtil.addWelcome('progress'); }" disabled>Generate</button>
    </li>
  </ul>

  <div id="input">
    <span class="field" id="message" contenteditable="true" onkeydown="if(event.keyCode === 13){event.preventDefault(); iSendMessage();}"></span>
    <span class="field button" id="send" onclick="iSendMessage();">Send</span>
    <span class="closed" id="toggleKeychain" onclick="iToggleKeychain();">
    <svg height="19" width="12" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <rect y="3" width="4" height="3" />
      <rect y="8" width="4" height="3" />
      <rect y="13" width="4" height="3" />
    </svg>
    </span>
  </div>

  <ul id="keychain"><li id="mykey">
      <div class="export" style="display: none;"><textarea></textarea></div>
      <div class="export" style="display: none;"><textarea></textarea></div>
      <h3></h3>
      <div class="controls"><span>PRIVATE KEY</span><span>PUBLIC KEY</span></div>
      <div class="info"></div>
  </li></ul>

  <script>
  if (typeof window.crypto.getRandomValues === 'function' && typeof window.WebSocket === 'function' && typeof window.Worker === 'function') {
    app.setCallbacks(
      function() {
        UiUtil.addWelcome('distribute');
        iSetRoom();
      }
    )

    comm.setCallbacks(
      function() {
        UiUtil.addWelcome('connect');
        iShowInput();
      },
      function() {
        UiUtil.addWelcome('disconnect');
        iHideInput();
      },
      function(msg) {
        UiUtil.addMessage(msg);
      },
      function(key) {
        UiUtil.addKey(key);
      }
    )
    
    window.onload = function() {
      app.server = app.getServer();
      app.room = app.getRoom();
      
      iSetRoom();
      document.getElementById("serverurl").innerHTML = app.server;
      document.getElementById("nickname").focus();
    }

    window.onresize = function(event) {
      if (comm.connected) {
        iShowInput();
        iToggleKeychain(true);
      }
      iToggleSettings(true);
    }
  } else {
    alert('Unfortunately, your browser does not have the necessary features to run this application. Please try Firefox 21+ or Chrome 11+.');
  }
  </script>
</body>
</html>
