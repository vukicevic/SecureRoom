<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>SecureRoom</title>
  <link href="resources/style.css" media="all" rel="stylesheet" type="text/css">

  <script src="resources/external/crunch.js"></script>
  <script src="resources/utils.js"></script>
  <script src="resources/random.default.js"></script>
  <script src="resources/hash.sha1.js"></script>
  <script src="resources/symmetric.aes.cfb.js"></script>
  <script src="resources/asymmetric.rsa.js"></script>
  <script src="resources/secureroom.js"></script>
  <script src="resources/ui.js"></script>

  <script type="text/html" id="template-message">
    <li class="message{{class}}"><div class="time">{{time}}</div><p><b class="cln">{{sender}}</b>{{message}}</p>{{info}}</li>
  </script>
  <script type="text/html" id="template-message-info">
    <ul class="info hidden-height">{{#info}}<li><b class="cln">{{term}}</b>{{data}}</li>{{/info}}</ul>
  </script>
  <script type="text/html" id="template-key-alert">
    <li id="alert-{{id}}" class="alert"><div class="time">{{time}}</div><p class="join">{{name}}</p><div class="info">{{info}}<button>Accept</button>&nbsp;<button>Reject</button></div></li>
  </script>
  <script type="text/html" id="template-key-info">
    <p><b>{{sid}}</b><br><small>{{ssize}} BITS | {{sdate}}</small></p>
  </script>
  <script type="text/html" id="template-key-chain">
    <li id="key-{{id}}"><div class="export hidden"><textarea wrap="off">{{data}}</textarea></div><h3>{{name}}</h3><div class="controls"><span class="{{status}}">{{state}}</span><span>PUBLIC KEY</span></div><div class="info">{{info}}</div></li>
  </script>
</head>
<body>
  <div id="menu">
    <span class="closed open" id="settingsToggle">
    <svg height="19" width="16" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <rect y="3" width="16" height="3"></rect>
      <rect y="8" width="16" height="3"></rect>
      <rect y="13" width="16" height="3"></rect>
    </svg>
    </span>
    <span id="room" onclick="window.prompt('Copy the URL of this SecureRoom: CTRL-C then Enter', window.location);">Room: -</span>
  </div>

  <ul id="settings">
    <li>
      <h3>Symmetric Cipher (AES)</h3>
      <div class="controls" id="symcsize">Size (bits): <span class="selected">128</span><span>192</span><span>256</span></div>
    </li>
    <li>
      <h3>Asymmetric Key (RSA)</h3>
      <div class="controls" id="asymsize">Size (bits): <span class="selected">1024</span><span>1536</span><span>2048</span><span>4096</span></div>
    </li>
    <li>
      <h3>WebSocket Connection</h3>
      <div class="controls">URL: <span id="serverurl" contenteditable="true" onkeydown="if(event.keyCode === 13)event.preventDefault();" onkeyup="app.setServer(this.textContent);"></span></div>
    </li>
  </ul>

  <ul id="content">
    <li class="alert" id="welcome">
      <input type="text" id="nickname" autocomplete="off" placeholder="Enter a name..." onkeyup="this.nextSibling.disabled = (this.value.length<3);" onkeypress="(event.keyCode===13) && this.nextSibling.onclick();"><button id="generate" onclick="if (!this.disabled) { app.generateKeys(this.previousSibling.value); UI.addWelcome('progress'); UI.disableSettings('asymsize'); }" disabled>Generate</button>
    </li>
  </ul>

  <div id="input">
    <div class="closed" id="keychainToggle">
      <svg height="19" width="12" xmlns="http://www.w3.org/2000/svg" version="1.1">
        <rect y="5" width="4" height="3"></rect>
        <rect y="10" width="4" height="3"></rect>
        <rect y="15" width="4" height="3"></rect>
      </svg>
    </div>
    <button id="send" onclick="var e = document.getElementById('message'); if (e.value) com.sendMessage(e.value); e.value = '';">Send</button>
    <span><input type="text" id="message" autocomplete="off" onkeyup="(event.keyCode === 13) && document.getElementById('send').click()"></span>
  </div>

  <ul id="keychain"><li id="mykey">
      <div class="export hidden"><textarea wrap="off"></textarea></div>
      <div class="export hidden"><textarea wrap="off"></textarea></div>
      <h3 id="myname"></h3>
      <div id="mycontrols" class="controls"><span>PRIVATE KEY</span><span>PUBLIC KEY</span></div>
      <div id="myinfo" class="info"></div>
  </li></ul>

  <script>
  if (typeof window.WebSocket === 'function' && typeof window.Worker === 'function') {
    var app, com, crunch = Crunch();

    window.onload = function() {
      app = SecureRoom(
              crunch,
              function() { UI.addWelcome('distribute'); UI.toggleSettings()('close'); UI.toggleKeychain()('close'); UI.toggleRoom() }
            );
      com = SecureComm(
              app,
              function() { UI.addWelcome('connect'); UI.toggleInput(false) },
              function() { UI.addWelcome('disconnect'); UI.toggleInput(true) },
              UI.addMessage,
              UI.addKey
            );

      UI.toggleRoom();

      document.getElementById("keychainToggle").addEventListener('click', UI.toggleKeychain());
      document.getElementById("settingsToggle").addEventListener('click', UI.toggleSettings());

      document.getElementById("symcsize").addEventListener('click', function (e) { if (e.target.tagName.toLowerCase() === "span") app.setSize('cipher', UI.toggleSize(e.target)) });
      document.getElementById("asymsize").addEventListener('click', function (e) { if (e.target.tagName.toLowerCase() === "span") app.setSize('key', UI.toggleSize(e.target)) });

      document.getElementById("serverurl").textContent = app.getServer();
      document.getElementById("nickname").focus();
    };

    window.onresize = function() {
      UI.toggleKeychain()('close');
      UI.toggleSettings()('close');
    }
  } else {
    alert('Your browser does not have the necessary features to run this application. Please try the latest Firefox, Chrome or Internet Explorer.');
  }
  </script>
</body>
</html>