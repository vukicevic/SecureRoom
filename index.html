<html>
<head>
  <title>SecureRoom</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link href="resources/style.css" media="all" rel="stylesheet" type="text/css">

  <script src="resources/random.default.js"></script>
  <script src="resources/symmetric.aes.cfb.js"></script>
  <script src="resources/asymmetric.rsa.js"></script>
  <script src="resources/hash.sha1.js"></script>
  <script src="resources/secureroom.js"></script>

  <script src="resources/keytools.js"></script>
  <script>

  function iSetRoom() {
    if (app.room != '') {
      if (app.getRoom() == '') {
        var opts = (window.location.search) ? window.location.search+'&room=' : '?room=',
            path = (window.location.pathname.substr(window.location.pathname.lastIndexOf('/')+1) == 'index.html') ? window.location.pathname+opts+app.room : window.location.pathname+app.room;
        window.history.replaceState({} , 'SecureRoom', path);
      }
      document.getElementById('room').innerHTML = 'Room: '+app.room;
    }
  }

  function TemplateTools(templ) {
    if (typeof templ != "undefined")
      templ = document.getElementById(templ).innerHTML.replace(/\n|\r/g, "").replace(/>\s+</g, "><").trim();

    return function compile(data, template) {
      var match, tpart, i, template = template || templ;

      while (match = /\{\{#([a-zA-Z]+)\}\}(.+)\{\{\/\1\}\}/g.exec(template)) {
        for (tpart = '', i = 0; i < data[match[1]].length; i++)
          tpart += compile(data[match[1]][i], match[2]);

        template = template.split(match[0]).join(tpart);
        delete data[match[1]];
      }

      for (match in data)
        template = template.split('{{'+match+'}}').join(data[match]);

      return template;
    }
  }

  var PrintUtil = {
    time: function(timestamp) {
      var date = new Date(timestamp*1000);
      return ('0'+date.getHours()).slice(-2)+' '+('0'+date.getMinutes()).slice(-2)+' '+('0'+date.getSeconds()).slice(-2);
    },

    date: function(timestamp) {
      var date = new Date(timestamp*1000);
      return date.getHours()+':'+('0'+date.getMinutes()).slice(-2)+':'+('0'+date.getSeconds()).slice(-2)+' '+date.getDate()+'/'+(date.getMonth()+1)+'/'+date.getFullYear();
    },

    text: function(text) {
      return text.replace(/["<>&]/g, function(m){return ({'"':'&quot;','<':'&lt;','>':'&gt;','&':'&amp;'})[m]});
    },

    bool: function(boolean) {
      return (boolean) ? 'True' : 'False';
    },

    number: function(number) {
      return number.toString();
    },

    id: function(id) {
      return id.match(/.{2}/g).map(function(v){return v;}).join(':').toUpperCase();
    }
  }

  function MessageTools(message) {
    return {
      strength: function() {
        var key, min = 8192;

        for (key in message.encrypted.keys) {
          if (typeof app.keychain[app.keymap[key]] == "undefined") {
            min = 8192;
            break;
          }
          min = Math.min(app.keychain[app.keymap[key]].encrypt.size, min);
        }

        return { term: 'Weakest Key', data: (min < 8192) ? min+' bits' : 'Unknown' };
      },

      recipients: function() {
        var key, list = [];

        for (key in message.encrypted.keys)
          if (typeof app.keychain[app.keymap[key]] != "undefined")
            list.push(PrintUtil.text(app.keychain[app.keymap[key]].name));
          else
            list.push((typeof app.rejected[app.keymap[key]] != "undefined") ? 'Rejected' : 'Unknown');

        return { term: 'Recipients', data: list.join(', ') };
      }
    }
  }

  var UiUtil = {
    toggleHeight: function(elem) {
      var height = elem.offsetHeight;

      if (elem.classList.contains('hidden-height')) {
        elem.style.height = '0px';
        elem.classList.remove('hidden-height');
      } else {
        elem.style.height = height+'px';
      }

      return function() {
        elem.style.height = (elem.style.height == '0px') ? height+'px' : '0px';
      }
    },

    toggleKeychain: function() {
      var elem = document.getElementById('keychain'),
          ctrl = document.getElementById('keychainToggle');

      return function(close) {
        if (ctrl.classList.contains('open') || close == 'close') {
          ctrl.classList.remove('open');
          elem.style.bottom = '-'+elem.clientHeight+'px';

          var node;
          while ( (node = elem.querySelector('.export:not(.hidden)')) ) node.classList.add('hidden');
          while ( (node = elem.querySelector('.selected')) ) node.classList.remove('selected');
        } else {
          ctrl.classList.add('open');
          elem.style.bottom = (ctrl.clientHeight-5)+'px';
        }
      };     
    },

    toggleSettings: function() {
      var ctrl = document.getElementById('settingsToggle'),
          elem = document.getElementById('settings');

      return function(close) {
        if (ctrl.classList.contains('open') || close == 'close') {
          window.scroll(0, document.body.offsetHeight);
          ctrl.classList.remove('open');
          elem.style.marginTop = '-'+(elem.clientHeight-ctrl.clientHeight)+'px';
        } else {
          window.scrollTo(0, 0);
          ctrl.classList.add('open');
          elem.style.marginTop = ctrl.clientHeight+'px';
        }
      };
    },

    toggleInput: function(close) {
      document.getElementById('input').style.bottom = (close) ? '-2.25em' : '0em';
    },

    toggleKey: function(id, ctrl) {
      return function() {
        if (app.keychain[id].active) {
          ctrl.classList.add('inactive');
          ctrl.textContent = 'DISABLED';
          app.keychain[id].active = false;
        } else {
          ctrl.classList.remove('inactive')
          ctrl.textContent = 'ACTIVE';
          app.keychain[id].active = true;
        }
      };
    },

    toggleExport: function(elem, ctrl) {
      return function() {
        if (elem.classList.contains('hidden')) {
          elem.classList.remove('hidden');
          ctrl.classList.add('selected');
        } else {
          elem.classList.add('hidden');
          ctrl.classList.remove('selected');
        }

        elem.style.left = (elem.parentNode.getBoundingClientRect().left - 1)+'px';
        elem.style.top  = '-'+(elem.offsetHeight - (elem.parentNode.getBoundingClientRect().top - elem.parentNode.parentNode.getBoundingClientRect().top))+'px';
      };
    },

    removeContent: function(elem) {
      elem.style.height = elem.offsetHeight+'px';

      return function() {
        elem.style.height = '0px';
        while (elem.firstChild) elem.removeChild(elem.firstChild);
      }
    },

    setSize: function(elem) {
      elem.parentNode.querySelector('.selected').classList.remove('selected');
      elem.classList.add('selected');
      return parseInt(elem.textContent);
    },

    disableSettings: function(setting) {
      var parent = document.getElementById(setting), node;
    
      switch(setting) {
      case 'asymsize':
        while ((node = parent.querySelector('span:not(.selected)')) ) parent.removeChild(node);
        break;
      case 'serverurl':
        parent.classList.add('selected');
        parent.contentEditable = false;
        break;
      }
    },

    addMessage: function(message) {
      var container = document.getElementById('content'),
          build = TemplateTools('template-message'),
          content = {};

      content.id      = PrintUtil.number(app.messages++);
      content.time    = PrintUtil.time(message.recvtime);
      content.sender  = PrintUtil.text(app.keychain[message.sender].name);
      content.message = PrintUtil.text(message.plaintext);
      content.info    = UiUtil.buildMsgInfo(message);
      content.class   = (!message.verified) ? ' warning' : '';

      container.insertAdjacentHTML('beforeend', build(content));

      UiUtil.addMessageListeners(document.getElementById('message-'+content.id));
    },

    addMessageListeners: function(elem) {
      elem.addEventListener('click', UiUtil.toggleHeight(elem.getElementsByClassName('info').item(0)));
    },

    addKey: function(key) {
      var container = document.getElementById('content'),
          build = TemplateTools('template-key-alert'),
          content = {};

      content.id   = PrintUtil.number(app.messages++);
      content.time = PrintUtil.time(Math.round(+new Date()/1000));
      content.name = PrintUtil.text(key.name);
      content.info = UiUtil.buildKeyInfo(key);

      container.insertAdjacentHTML('beforeend', build(content));

      UiUtil.addKeyListeners(document.getElementById('alert-'+content.id), key);
    },

    addKeyListeners: function(elem, key) {
      var a = elem.getElementsByTagName('button').item(0),
          r = elem.getElementsByTagName('button').item(1),
          p = elem.getElementsByClassName('join').item(0),
          d = UiUtil.removeContent(a.parentNode);

      a.addEventListener('click', function() { 
        key.active = true;
        app.keychain[key.sign.id] = key;
        app.keymap[key.encrypt.id] = key.sign.id;
        comm.sendKey();
      });

      a.addEventListener('click', function() { 
        p.classList.remove('join');
        p.classList.add('accept');
        UiUtil.buildKeychain();
      });

      a.addEventListener('click', d);

      r.addEventListener('click', function() { 
        key.active = false;
        app.rejected[key.sign.id] = key;
        app.keymap[key.encrypt.id] = key.sign.id;
      });

      r.addEventListener('click', function() { 
        elem.classList.add('warning');
        p.classList.remove('join');
        p.classList.add('reject');
      });
      
      r.addEventListener('click', d);
    },

    buildMsgInfo: function(message) {
      var tools = MessageTools(message),
          build = TemplateTools('template-message-info'),
          content = {info: []};

      content.info.push({term: 'Verified', data: PrintUtil.bool(message.verified)});
      content.info.push({term: 'Author', data: PrintUtil.id(message.sender)});
      content.info.push({term: 'Cipher', data: symmetric.name+'-'+(message.sessionkey.length*8)+' ['+symmetric.mode+']'});
      content.info.push({term: 'Delay', data: (message.recvtime - message.sendtime)+' sec'});
      content.info.push(tools.recipients());
      content.info.push(tools.strength());

      return build(content);
    },

    buildKeyInfo: function(key) {
      var build = TemplateTools('template-key-info'),
          content = {};

      content.sid   = PrintUtil.id(key.sign.id);
      content.ssize = PrintUtil.number(key.sign.size);
      content.sdate = PrintUtil.date(key.sign.created);

      content.eid   = PrintUtil.id(key.encrypt.id);
      content.esize = PrintUtil.number(key.encrypt.size);
      content.edate = PrintUtil.date(key.encrypt.created);

      return build(content);
    },

    buildKeychain: function() {
      var container = document.getElementById('keychain'),
          build = TemplateTools('template-key-chain'),
          content = {};

      while (container.lastChild != container.firstChild) container.removeChild(container.lastChild);

      for (var id in app.keychain) {
        if (app.myid != id) {
          content.id     = PrintUtil.text(id);
          content.name   = PrintUtil.text(app.keychain[id].name);
          content.status = (app.keychain[id].active) ? '' : 'inactive';
          content.info   = UiUtil.buildKeyInfo(app.keychain[id]);
          content.data   = KeyTools.exportKey(app.keychain[id].name, app.keychain[id].sign, app.keychain[id].encrypt);

          container.insertAdjacentHTML('beforeend', build(content));

          UiUtil.addKeychainListeners(container.lastChild, id);
        }
      }

      UiUtil.toggleKeychain()('close');
    },

    addKeychainListeners: function(elem, id) {
      var b1 = elem.getElementsByTagName('span').item(0),
          b2 = elem.getElementsByTagName('span').item(1),
          ex = elem.getElementsByClassName('export').item(0);
      
      b1.addEventListener('click', UiUtil.toggleKey(id, b1));
      b2.addEventListener('click', UiUtil.toggleExport(ex, b2));
    },

    addWelcome: function(type) {
      var container = document.getElementById('welcome');
      while (container.firstChild) container.removeChild(container.firstChild);
      
      switch(type) {
      case 'distribute':
        container.insertAdjacentHTML('beforeend', '<p>Your keys have been generated.</p><div class="info">'+UiUtil.buildKeyInfo(app.keychain[app.myid])+'</div><button>Connect &amp; Distribute</button>');
        container.getElementsByTagName('button').item(0).addEventListener('click', function() { comm.connect(); iSetRoom(); UiUtil.addWelcome('progress'); UiUtil.disableSettings('serverurl') });
        UiUtil.addMyKey();
        break;
      case 'progress':
        container.insertAdjacentHTML('beforeend', '<div class="loading"></div>');
        break;
      case 'connect':
        container.insertAdjacentHTML('beforeend', '<div class="time">'+PrintUtil.time(Math.round(+new Date()/1000))+'</div><p>Connected.</p>');
        break;
      case 'disconnect':
        container.insertAdjacentHTML('beforeend', '<div class="time">'+PrintUtil.time(Math.round(+new Date()/1000))+'</div><p>Disconnected.</p>');
        break;   
      }
    },

    addMyKey: function() {
      document.getElementById('myinfo').insertAdjacentHTML('beforeend', UiUtil.buildKeyInfo(app.keychain[app.myid]));
      document.getElementById('myname').insertAdjacentHTML('beforeend', PrintUtil.text(app.keychain[app.myid].name));
    }
  }
  </script>

  <script type="text/html" id="template-message">
    <li id="message-{{id}}" class="message{{class}}">
      <div class="time">{{time}}</div>
      <p><b class="cln">{{sender}}</b>{{message}}</p>
      {{info}}
    </li>
  </script>

  <script type="text/html" id="template-message-info">
    <ul class="info hidden-height">
      {{#info}}
      <li><b class="cln">{{term}}</b>{{data}}</li>
      {{/info}}
    </ul>
  </script>

  <script type="text/html" id="template-key-alert">
    <li id="alert-{{id}}" class="alert">
      <div class="time">{{time}}</div>
      <p class="join">{{name}}</p>
      <div class="info">
        {{info}}
        <button>Accept</button><button>Reject</button>
      </div>
    </li>
  </script>

  <script type="text/html" id="template-key-info">
    <p><b>{{sid}}</b><br><small>{{ssize}} | {{sdate}} | SIGNING</small></p>
    <p>{{eid}}<br><small>{{esize}} | {{edate}} | ENCRYPTION</small></p>
  </script>

  <script type="text/html" id="template-key-chain">
    <li id="key-{{id}}">
      <div class="export hidden"><textarea>{{data}}</textarea></div>
      <h3>{{name}}</h3>
      <div class="controls"><span class="{{status}}">ACTIVE</span><span>PUBLIC KEY</span></div>
      <div class="info">{{info}}</div>
    </li>
  </script>
</head>
<body>
  <div id="menu">
    <span class="closed open" id="settingsToggle">
    <svg height="19" width="16" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <rect y="3" width="16" height="3" />
      <rect y="8" width="16" height="3" />
      <rect y="13" width="16" height="3" />
    </svg>
    </span>
    <span id="room">Room: -</span>
  </div>

  <ul id="settings">
    <li>
      <h3>Symmetric Cipher (AES)</h3>
      <div class="controls" id="symcsize">Size (bits): <span class="selected">128</span><span>192</span><span>256</span></div>
    </li>
    <li>
      <h3>Asymmetric Key (RSA)</h3>
      <div class="controls" id="asymsize">Size (bits): <span class="selected">1024</span><span>1536</span><span>2048</span></div>
    </li>
    <li>
      <h3>WebSocket Connection</h3>
      <div class="controls">URL: <span id="serverurl" contenteditable="true" onkeydown="if(event.keyCode === 13)event.preventDefault();" onkeyup="app.server=this.textContent;"></span></div>
    </li>
  </ul>

  <ul id="content">
    <li class="alert" id="welcome">
      <input type="text" id="nickname" autocomplete="off" placeholder="Enter a nickname..." onkeyup="this.nextSibling.disabled = (this.value.length<3);" onkeypress="(event.keyCode===13) && this.nextSibling.onclick();"><button onclick="if (!this.disabled) { app.generateKeys(this.previousSibling.value); UiUtil.addWelcome('progress'); UiUtil.disableSettings('asymsize'); }" disabled>Generate</button>
    </li>
  </ul>

  <div id="input">
    <div class="closed" id="keychainToggle">
      <svg height="19" width="12" xmlns="http://www.w3.org/2000/svg" version="1.1">
        <rect y="5" width="4" height="3" />
        <rect y="10" width="4" height="3" />
        <rect y="15" width="4" height="3" />
      </svg>
    </div>
    <button id="send" onclick="var e = document.getElementById('message'); if (e.value) UiUtil.addMessage(comm.sendMessage(e.value)); e.value = '';">Send</button>
    <span><input type="text" id="message" onkeyup="(event.keyCode === 13) && document.getElementById('send').click()"></span>
  </div>

  <ul id="keychain"><li id="mykey">
      <div class="export hidden"><textarea></textarea></div>
      <div class="export hidden"><textarea></textarea></div>
      <h3 id="myname"></h3>
      <div id="mycontrols" class="controls"><span>PRIVATE KEY</span><span>PUBLIC KEY</span></div>
      <div id="myinfo" class="info"></div>
  </li></ul>

  <script>
  if (typeof window.crypto.getRandomValues === 'function' && typeof window.WebSocket === 'function' && typeof window.Worker === 'function') {
    app.setCallbacks(
      function() {
        UiUtil.addWelcome('distribute');
        UiUtil.toggleSettings()('close');
        iSetRoom();
      }
    )

    comm.setCallbacks(
      function() {
        UiUtil.addWelcome('connect');
        UiUtil.toggleInput(false);
      },
      function() {
        UiUtil.addWelcome('disconnect');
        UiUtil.toggleInput(true);
      },
      function(msg) {
        UiUtil.addMessage(msg);
      },
      function(key) {
        UiUtil.addKey(key);
      }
    )
    
    window.onload = function() {
      app.server = app.getServer();
      app.room = app.getRoom();
      
      iSetRoom();

      document.getElementById("keychainToggle").addEventListener('click', UiUtil.toggleKeychain());
      document.getElementById("settingsToggle").addEventListener('click', UiUtil.toggleSettings());

      document.getElementById("symcsize").addEventListener('click', function (e) { if (e.target.tagName.toLowerCase() == "span") app.ciphersize = UiUtil.setSize(e.target) });
      document.getElementById("asymsize").addEventListener('click', function (e) { if (e.target.tagName.toLowerCase() == "span") app.keysize = UiUtil.setSize(e.target) });

      document.getElementById("serverurl").innerHTML = app.server;
      document.getElementById("nickname").focus();
    }

    window.onresize = function(event) {
      UiUtil.toggleKeychain()('close');
      UiUtil.toggleSettings()('close');
    }
  } else {
    alert('Unfortunately, your browser does not have the necessary features to run this application. Please try Firefox 21+ or Chrome 11+.');
  }
  </script>
</body>
</html>