<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Test</title>

  <script src="resources/external/crunch.js"></script>
  <script src="resources/utils.js"></script>
  <script src="resources/random.default.js"></script>
  <script src="resources/hash.sha1.js"></script>
  <script src="resources/asymmetric.rsa.js"></script>
</head>
<body>
<script>
function Key(material, created, name) {
  this.material    = material;
  this.created     = created;
  this.name        = name;
  this.signatures  = {};

  this.type        = (typeof name !== "undefined") ? 3 : 2;
  this.fingerprint = this.generateFingerprint();
}

Key.hash   = Hash();
Key.oracle = Asymmetric(Crunch(), Key.hash);

Key.prototype = {

    get id () {
      return this.fingerprint.substr(-16);
    },

    get json () {
      var json = {};
      
      json.created    = this.created;
      json.signatures = this.signatures;
      
      json.material   = {};
      json.material.e = this.material.e;
      json.material.n = this.material.n;

      if (typeof name !== "undefined")
        json.name = this.name;

      return json;
    },

    //TEMP WORKAROUNG
    get data () {
      return this.material;
    },
    //TEMP WORKAROUNG

    get size () {
      return ArrayUtil.bitLength(material.n);
    }
}

Key.prototype.makeBase = function() {
    return [4]
        .concat(ArrayUtil.fromWord(this.created))
        .concat([this.type])
        .concat(ArrayUtil.makeMpi(this.material.n))
        .concat(ArrayUtil.makeMpi(this.material.e));
}

Key.prototype.makeSignatureBase = function() {
    return (type === 3)
    ? [4,19,3,2,0,26,5,2]
      .concat(ArrayUtil.fromWord(this.created))
      .concat([2,27,3,5,9])
      .concat(ArrayUtil.fromWord(86400))
      .concat([4,11,7,8,9,2,21,2,2,22,0])
    : [4,24,2,2,0,15,5,2]
      .concat(ArrayUtil.fromWord(this.created))
      .concat([2,27,4,5,9])
      .concat(ArrayUtil.fromWord(86400));
}

Key.prototype.generateFingerprint = function() {
  var base = this.makeBase();

  return ArrayUtil.toHex(Key.hash.digest([153].concat(ArrayUtil.fromHalf(base.length)).concat(base)));
}

Key.prototype.generateSignatureHash = function(signer) {
    var keyHead, sigHead, suffix, 
        base = signer.makeBase();

    if (this.type === 3) {
      keyHead = [180].concat(ArrayUtil.fromWord(this.name.length)).concat(ArrayUtil.fromString(this.name));
    } else {
      keyHead = this.makeBase();
      keyHead = [153].concat(ArrayUtil.fromHalf(keyHead.length)).concat(keyHead);
    }

    sigHead = this.makeSignatureBase();

    suffix  = [4,255].concat(ArrayUtil.fromWord(sigHead.length));

    return hash.digest(
      [153].concat(ArrayUtil.fromHalf(base.length)).concat(base).concat(keyHead).concat(sigHead).concat(suffix)
    );
  }

Key.prototype.sign = function(signer) {
    if (signer.isPrivate() && signer.isMaster()) {
        var signatureHash = this.generateSignatureHash(signer),
            sigdata = {};

        sigdata.signature = Key.oracle.sign(signer, signatureHash, true);
        sigdata.hashcheck = signatureHash.slice(0, 2);

        this.signatures[signer.id] = sigdata;
    }
}

Key.prototype.verify = function(signer) {
    if (typeof this.signatures[signer.id] !== "undefined") {
       return Key.oracle.verify(signer, this.generateSignatureHash(signer), this.signatures[signer.id].signature, true);
    }
}

Key.prototype.isMaster = function() {
    return this.type === 3;
}

Key.prototype.isPrivate = function() {
    return typeof this.material.d !== "undefined";
}



  var user;
  //var exporter = ExportUtil();

  function onKey(d,t) {
    user = new Key(d, ~~(Date.now()/1000), "Test")
  }
  
  KeyGen(1024, onKey, crunch)();

</script>
</body>
</html>